async function fetchAgentSkills(userId, token) {
  try {
    const response = await fetch(`https://api.mypurecloud.ie/api/v2/users/${userId}/routingskills`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    const skillsData = await response.json();

    // Map each skill with proficiency
    return skillsData.entities.length > 0
      ? skillsData.entities.map(skill => ({
          name: skill.name,
          proficiency: skill.proficiency
        }))
      : [];
  } catch (error) {
    console.error(`Error fetching skills for ${userId}:`, error);
    return [];
  }
}

async function fetchQueueProficiency(agentId, queueId, token) {
  try {
    // Fetch the proficiency for a specific queue and agent
    const response = await fetch(`https://api.mypurecloud.ie/api/v2/users/${agentId}/routingskills?queueId=${queueId}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    const proficiencyData = await response.json();

    return proficiencyData.entities.length > 0
      ? proficiencyData.entities[0].proficiency // Assuming the first skill corresponds to the queue proficiency
      : 0; // Return 0 if no proficiency found
  } catch (error) {
    console.error("Error fetching queue proficiency:", error);
    return 0;
  }
}

async function fetchAgents(token) {
  const queueId = document.getElementById('queueDropdown').value;
  const skillId = document.getElementById('skillDropdown').value;
  const agentId = document.getElementById('agentDropdown').value;

  if (!queueId && !skillId && !agentId) {
    alert('Please select a queue, skill, or agent first.');
    return;
  }

  let agents = [];
  if (agentId) {
    agents = await fetchAgentById(agentId, token);
  } else if (queueId) {
    agents = await fetchAgentsByQueue(queueId, token);
  } else if (skillId) {
    agents = await fetchAgentsBySkill(skillId, token);
  }

  const tableBody = document.querySelector("#agentsTable tbody");
  tableBody.innerHTML = "";

  for (const agent of agents) {
    const currentSkills = await fetchAgentSkills(agent.id, token);
    let queueProficiency = 0;

    // Fetch queue proficiency for each agent
    if (queueId) {
      queueProficiency = await fetchQueueProficiency(agent.id, queueId, token);
    }

    let row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="checkbox" data-user-id="${agent.id}"></td>
      <td>${agent.name}</td>
      <td>${currentSkills.map(skill => skill.name).join(", ")}</td>
      <td>${queueProficiency}</td> <!-- New column for queue proficiency -->
      <td>
        <select data-user-id="${agent.id}">
          <option value="">Select Skill</option>
          ${availableSkills.map(skill => `<option value="${skill.id}">${skill.name}</option>`).join('')}
        </select>
      </td>
      <td><input type="number" min="0" max="5" step="0.1" data-user-id="${agent.id}" placeholder="Proficiency"></td>
    `;
    tableBody.appendChild(row);
  }
}
