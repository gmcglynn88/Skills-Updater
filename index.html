<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPI Skill Updates</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    /* Aptos first, then fallbacks */
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg);font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;align-items:end}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .loading{opacity:.6;pointer-events:none}
    .selection-section{margin-bottom:20px;padding:15px;border:1px solid var(--border-color);border-radius:8px;background-color: var(--light-bg)}
    .selection-section h3{margin-top:0;color:var(--primary-color)}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid var(--border-color);padding:10px;text-align:left;vertical-align:top}
    th{background-color:var(--primary-color);color:#fff}
    .select-all-checkbox{margin-bottom:10px}
    .error-message{color:#d9534f;padding:10px;margin:10px 0;border:1px solid #d9534f;border-radius:4px;background:#f9f2f2}
    .success-message{color:#3c763d;padding:10px;margin:10px 0;border:1px solid #3c763d;border-radius:4px;background:#dff0d8}
    .tab-container{display:flex;margin-bottom:20px;border-bottom:1px solid var(--border-color)}
    .tab{padding:12px 24px;cursor:pointer;border:1px solid var(--border-color);border-bottom:none;border-radius:8px 8px 0 0;margin-right:4px;background: var(--light-bg);transition:background .2s}
    .tab.active{background:var(--primary-color);color:white;border-color:var(--primary-color)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .prof-wrap{display:flex;gap:8px;align-items:center;margin-top:6px}
    .prof-input,.prof-input-change{width:90px}
    .muted{color:var(--text-light);font-size:12px}
    
    /* Bulk section - improved layout */
    .bulk-section{background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #dee2e6;margin-bottom:24px;display:grid;grid-template-columns:1fr auto auto;gap:20px;align-items:end}
    .bulk-skill-selector{min-width:300px}
    .bulk-proficiency{display:flex;align-items:center;gap:10px;min-width:200px}
    .bulk-proficiency label{margin-bottom:0;white-space:nowrap}
    .bulk-proficiency-controls{display:flex;align-items:center;gap:6px}
    .bulk-action{min-width:180px}
    
    /* Small buttons */
    .small-btn{padding:8px 16px;font-size:14px}
    .tiny-btn{padding:4px 10px;font-size:12px;min-width:32px}
    
    /* Checkbox dropdown */
    .checkbox-dropdown{position:relative;min-width:220px;width:100%}
    .cd-trigger{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border-color);border-radius:6px;background:#fff;padding:10px;cursor:pointer;width:100%;box-sizing:border-box}
    .cd-trigger .label{color:var(--text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .cd-trigger .count{background:var(--pill);border:1px solid var(--border-color);border-radius:999px;padding:2px 8px;font-size:12px;color:#2c3e50;flex-shrink:0;margin-left:8px}
    .cd-panel{position:absolute;z-index:1000;margin-top:6px;background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;max-height:340px;overflow:hidden;display:none;box-sizing:border-box}
    .cd-panel.open{display:block}
    .cd-header{padding:10px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}
    .cd-search{flex:1;border:1px solid var(--border-color);border-radius:6px;padding:8px;width:100%;box-sizing:border-box}
    .cd-actions{display:flex;gap:8px}
    .cd-actions button{background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);border-radius:6px;padding:8px 10px;cursor:pointer;white-space:nowrap}
    .cd-selectall{padding:8px 12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px}
    .cd-list{max-height:260px;overflow:auto}
    .cd-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f3f5}
    .cd-item label{display:flex;align-items:center;gap:10px;cursor:pointer;width:100%}
    .cd-footer{padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);font-size:12px;color:var(--text-light);display:flex;justify-content:space-between}
    
    /* Small proficiency input */
    .small-prof-input{width:70px;padding:6px 8px;font-size:13px}
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .controls {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      .bulk-section {
        grid-template-columns: 1fr auto;
      }
      .bulk-proficiency {
        grid-column: 1 / -1;
      }
    }
    
    @media (max-width: 768px) {
      .controls {
        grid-template-columns: 1fr;
      }
      .bulk-section {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      .bulk-proficiency {
        grid-column: auto;
      }
      .bulk-action {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>
  <h1>Skill Management Tool</h1>

  <div id="loginSection" class="card" style="text-align:center;margin:20px;">
    <div class="loading">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer" style="display:none;"></div>

    <div class="tab-container">
      <div class="tab active" data-tab="remove">Remove Skills</div>
      <div class="tab" data-tab="add">Add Skills</div>
      <div class="tab" data-tab="change">Change Proficiency</div>
    </div>

    <!-- Remove Tab -->
    <div id="removeTab" class="tab-content active">
      <div class="selection-section">
        <h3>Search Options</h3>
        <div class="controls">
          <div>
            <label>Select Management Units</label>
            <div id="managementUnitDropdownRemove" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Queues</label>
            <div id="queueDropdownRemove" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Agents</label>
            <div id="agentDropdownRemove" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Skills</label>
            <div id="skillDropdownRemove" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Teams</label>
            <div id="teamDropdownRemove" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="fetchUsersRemove" class="full-width-btn">Get Users</button>
          </div>
        </div>
        <div class="muted">One or multiple filters must be selected to view</div>
      </div>

      <div class="card">
        <div class="bulk-section">
          <div class="bulk-skill-selector">
            <label>Apply to All Selected Users</label>
            <div id="bulkSkillRemoveDropdown" class="checkbox-dropdown"></div>
          </div>
          <div class="bulk-action">
            <label>&nbsp;</label>
            <button id="applyBulkRemove" class="full-width-btn small-btn">Apply to Selected Users</button>
          </div>
        </div>
        
        <h2 style="margin:0 0 12px;">Routing Skills — Remove</h2>
        <table id="userSkillsTableRemove">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsersRemove" class="select-all-checkbox"></th>
              <th>Agent</th>
              <th>Skills Assigned</th>
              <th>Action</th>
            </tr>
          </thead><tbody></tbody>
        </table>
        <button id="removeSkills" class="full-width-btn" disabled>Remove Selected Skills from Selected Users</button>
      </div>
    </div>

    <!-- Add Tab -->
    <div id="addTab" class="tab-content">
      <div class="selection-section">
        <h3>Search Options</h3>
        <div class="controls">
          <div>
            <label>Select Management Units</label>
            <div id="managementUnitDropdownAdd" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Queues</label>
            <div id="queueDropdownAdd" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Agents</label>
            <div id="agentDropdownAdd" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Skills</label>
            <div id="skillDropdownAdd" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Teams</label>
            <div id="teamDropdownAdd" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="fetchUsersAdd" class="full-width-btn">Get Users</button>
          </div>
        </div>
        <div class="muted">Type or nudge proficiency in 0.5 steps (1–5). I'll preselect a missing skill if you filtered by it.</div>
      </div>

      <div class="card">
        <div class="bulk-section">
          <div class="bulk-skill-selector">
            <label>Apply to All Selected Users</label>
            <div id="bulkSkillAddDropdown" class="checkbox-dropdown"></div>
          </div>
          <div class="bulk-proficiency">
            <label>Proficiency</label>
            <div class="bulk-proficiency-controls">
              <button type="button" class="tiny-btn" id="bulkProfDec">−</button>
              <input type="number" step="0.5" min="1" max="5" value="3.0" id="bulkProfInput" class="small-prof-input" />
              <button type="button" class="tiny-btn" id="bulkProfInc">+</button>
            </div>
          </div>
          <div class="bulk-action">
            <label>&nbsp;</label>
            <button id="applyBulkAdd" class="full-width-btn small-btn">Apply to Selected Users</button>
          </div>
        </div>
        
        <h2 style="margin:0 0 12px;">Routing Skills — Add</h2>
        <table id="userSkillsTableAdd">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsersAdd" class="select-all-checkbox"></th>
              <th>Agent</th>
              <th>Skills Assigned</th>
              <th>Action</th>
            </tr>
          </thead><tbody></tbody>
        </table>
        <button id="addSkills" class="full-width-btn" disabled>Add Selected Skills to Selected Users</button>
      </div>
    </div>

    <!-- Change Tab -->
    <div id="changeTab" class="tab-content">
      <div class="selection-section">
        <h3>Search Options</h3>
        <div class="controls">
          <div>
            <label>Select Management Units</label>
            <div id="managementUnitDropdownChange" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Queues</label>
            <div id="queueDropdownChange" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Agents</label>
            <div id="agentDropdownChange" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Filter by Skills (optional)</label>
            <div id="skillDropdownChange" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Teams</label>
            <div id="teamDropdownChange" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="fetchUsersChange" class="full-width-btn">Get Users</button>
          </div>
        </div>
        <div class="muted">Choose users, pick a skill per row, then tweak the number or nudge ±0.5.</div>
      </div>

      <div class="card">
        <div class="bulk-section">
          <div class="bulk-skill-selector">
            <label>Apply to All Selected Users</label>
            <div id="bulkSkillChangeDropdown" class="checkbox-dropdown"></div>
          </div>
          <div class="bulk-proficiency">
            <label>New Proficiency</label>
            <div class="bulk-proficiency-controls">
              <button type="button" class="tiny-btn" id="bulkProfChangeDec">−</button>
              <input type="number" step="0.5" min="1" max="5" value="3.0" id="bulkProfChangeInput" class="small-prof-input" />
              <button type="button" class="tiny-btn" id="bulkProfChangeInc">+</button>
            </div>
          </div>
          <div class="bulk-action">
            <label>&nbsp;</label>
            <button id="applyBulkChange" class="full-width-btn small-btn">Apply to Selected Users</button>
          </div>
        </div>
        
        <h2 style="margin:0 0 12px;">Routing Skills — Change Proficiency</h2>
        <table id="userSkillsTableChange">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsersChange" class="select-all-checkbox"></th>
              <th>Agent</th>
              <th>Skills Assigned</th>
              <th>Change To</th>
            </tr>
          </thead><tbody></tbody>
        </table>
        <button id="updateProficiency" class="full-width-btn" disabled>Update Proficiency for Selected</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/Skills-Updater/';
    const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;

    // ===== STATE =====
    let token = null;
    let availableUsers = [];
    let availableTeams = [];
    let availableSkills = [];
    let availableManagementUnits = [];
    let availableQueues = [];

    // Shared selections across tabs
    const sharedSelections = {
      agentIds: [],
      skillIds: [],
      teamIds: [],
      managementUnitIds: [],
      queueIds: []
    };

    // Checkbox dropdown instances (per tab)
    const dd = {
      agent: { remove:null, add:null, change:null },
      skill: { remove:null, add:null, change:null },
      team:  { remove:null, add:null, change:null },
      managementUnit: { remove:null, add:null, change:null },
      queue: { remove:null, add:null, change:null }
    };

    // Bulk dropdown instances
    const bulkDd = {
      remove: null,
      add: null,
      change: null
    };

    // ===== OAUTH BOOT =====
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.hash.substring(1));
      token = params.get('access_token');
      if (token) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        initializeApp();
      } else {
        window.location.href = oauthUrl;
      }
    });

    function showMessage(message, type='error'){
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${message}</div>`;
      box.style.display = 'block';
      if (type === 'success') setTimeout(()=> box.style.display = 'none', 5000);
    }
    function authHeaders(){ return { "Authorization":`Bearer ${token}`, "Content-Type":"application/json" }; }
    async function safeJson(res){ try{ return await res.json(); } catch{ return null; } }
    const cap = s => s.charAt(0).toUpperCase()+s.slice(1);

    // ===== INIT =====
    async function initializeApp(){
      try {
        await Promise.all([
          fetchAllUsers(), 
          fetchAllTeams(), 
          fetchAllSkills(), 
          fetchAllManagementUnits(),
          fetchAllQueues()
        ]);
        createAllDropdowns();
        createBulkDropdowns();
        populateDropdowns();
        setupEventListeners();
        setupBulkControls();
      } catch (e) {
        console.error(e);
        showMessage('Error initializing application. Please try again.');
        setTimeout(()=> window.location.href = oauthUrl, 3000);
      }
    }

    // ===== DATA =====
    async function fetchAllUsers(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(`https://api.mypurecloud.ie/api/v2/users?pageNumber=${page}&pageSize=${size}`, { headers: authHeaders() });
        if (!res.ok) throw new Error((await safeJson(res))?.message || 'Failed to fetch users');
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0; page++;
      } while (all.length < total);
      availableUsers = all;
    }
    async function fetchAllTeams(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(`https://api.mypurecloud.ie/api/v2/teams?pageNumber=${page}&pageSize=${size}`, { headers: authHeaders() });
        if (!res.ok) throw new Error((await safeJson(res))?.message || 'Failed to fetch teams');
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0; page++;
      } while (all.length < total);
      availableTeams = all;
    }
    async function fetchAllSkills(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(`https://api.mypurecloud.ie/api/v2/routing/skills?pageNumber=${page}&pageSize=${size}`, { headers: authHeaders() });
        if (!res.ok) throw new Error((await safeJson(res))?.message || 'Failed to fetch skills');
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0; page++;
      } while (all.length < total);
      availableSkills = all;
    }
    async function fetchAllManagementUnits(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(`https://api.mypurecloud.ie/api/v2/workforcemanagement/managementunits?pageNumber=${page}&pageSize=${size}`, { headers: authHeaders() });
        if (!res.ok) throw new Error((await safeJson(res))?.message || 'Failed to fetch management units');
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0; page++;
      } while (all.length < total);
      availableManagementUnits = all;
    }
    async function fetchAllQueues(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(`https://api.mypurecloud.ie/api/v2/routing/queues?pageNumber=${page}&pageSize=${size}`, { headers: authHeaders() });
        if (!res.ok) throw new Error((await safeJson(res))?.message || 'Failed to fetch queues');
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0; page++;
      } while (all.length < total);
      availableQueues = all;
    }

    // ===== GENERIC CHECKBOX DROPDOWN =====
    function createCheckboxDropdown(containerId, { placeholder, searchPlaceholder }, mode){
      const root = document.getElementById(containerId);
      root.innerHTML = '';

      const trigger = document.createElement('div');
      trigger.className = 'cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);

      const panel = document.createElement('div');
      panel.className = 'cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions">
            <button type="button" data-cd="clear">Clear</button>
          </div>
        </div>
        <div class="cd-selectall">
          <label><input type="checkbox" data-cd="selectall"/> Select all</label>
        </div>
        <div class="cd-list"></div>
        <div class="cd-footer">
          <span data-cd="summary">0 selected</span>
          <span>Click outside to close</span>
        </div>
      `;
      root.appendChild(panel);

      const list = panel.querySelector('.cd-list');
      const search = panel.querySelector('.cd-search');
      const clearBtn = panel.querySelector('[data-cd="clear"]');
      const selectAll = panel.querySelector('[data-cd="selectall"]');
      const summary = panel.querySelector('[data-cd="summary"]');

      let options = [];
      let selected = new Set();

      function render(filter=''){
        const ft = filter.trim().toLowerCase();
        list.innerHTML = '';
        const filtered = !ft ? options : options.filter(o => (o.label||'').toLowerCase().includes(ft));
        if (!filtered.length){ list.innerHTML = `<div class="cd-item" style="color:#6C757D">No matches</div>`; return; }
        filtered.forEach(o=>{
          const id = `${containerId}__${o.value}`;
          const row = document.createElement('div');
          row.className = 'cd-item';
          row.innerHTML = `
            <label for="${id}">
              <input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value)?'checked':''}/>
              <span>${o.label || o.value}</span>
            </label>
          `;
          const cb = row.querySelector('input');
          cb.addEventListener('change', ()=>{
            if (cb.checked) selected.add(o.value); else selected.delete(o.value);
            updateSummary(); updateSelectAllState();
            if (mode) updateSharedSelections(containerId, Array.from(selected), mode);
          });
          list.appendChild(row);
        });
      }
      function updateSummary(){
        trigger.querySelector('.count').textContent = `${selected.size} selected`;
        summary.textContent = `${selected.size} selected`;
      }
      function updateSelectAllState(){
        const total = options.length, count = selected.size;
        selectAll.indeterminate = count>0 && count<total;
        selectAll.checked = total>0 && count===total;
      }

      trigger.addEventListener('click', ()=>{ panel.classList.toggle('open'); search.focus(); });
      document.addEventListener('click', (e)=>{ if (!root.contains(e.target)) panel.classList.remove('open'); });
      search.addEventListener('input', ()=> render(search.value));
      clearBtn.addEventListener('click', ()=>{ 
        selected.clear(); 
        render(search.value); 
        updateSummary(); 
        updateSelectAllState();
        if (mode) updateSharedSelections(containerId, [], mode);
      });
      selectAll.addEventListener('change', ()=>{
        if (selectAll.checked) options.forEach(o=> selected.add(o.value)); 
        else selected.clear();
        render(search.value); 
        updateSummary();
        if (mode) updateSharedSelections(containerId, Array.from(selected), mode);
      });

      function setOptions(newOptions){
        options = newOptions || [];
        selected.forEach(v=>{ if (!options.some(o=>o.value===v)) selected.delete(v); });
        render(search.value); 
        updateSummary(); 
        updateSelectAllState();
      }
      function getSelectedValues(){ return Array.from(selected); }
      function setSelectedValues(values){
        selected = new Set(values);
        render(search.value);
        updateSummary();
        updateSelectAllState();
      }

      render('');
      return { setOptions, getSelectedValues, setSelectedValues };
    }

    function createAllDropdowns(){
      // Agents
      dd.agent.remove = createCheckboxDropdown('agentDropdownRemove', { placeholder:'Select agents', searchPlaceholder:'Search agents...' }, 'remove');
      dd.agent.add    = createCheckboxDropdown('agentDropdownAdd',    { placeholder:'Select agents', searchPlaceholder:'Search agents...' }, 'add');
      dd.agent.change = createCheckboxDropdown('agentDropdownChange', { placeholder:'Select agents', searchPlaceholder:'Search agents...' }, 'change');
      // Skills
      dd.skill.remove = createCheckboxDropdown('skillDropdownRemove', { placeholder:'Select skills', searchPlaceholder:'Search skills...' }, 'remove');
      dd.skill.add    = createCheckboxDropdown('skillDropdownAdd',    { placeholder:'Select skills', searchPlaceholder:'Search skills...' }, 'add');
      dd.skill.change = createCheckboxDropdown('skillDropdownChange', { placeholder:'Select skills', searchPlaceholder:'Search skills...' }, 'change');
      // Teams
      dd.team.remove  = createCheckboxDropdown('teamDropdownRemove',  { placeholder:'Select teams',  searchPlaceholder:'Search teams...' }, 'remove');
      dd.team.add     = createCheckboxDropdown('teamDropdownAdd',     { placeholder:'Select teams',  searchPlaceholder:'Search teams...' }, 'add');
      dd.team.change  = createCheckboxDropdown('teamDropdownChange',  { placeholder:'Select teams',  searchPlaceholder:'Search teams...' }, 'change');
      // Management Units
      dd.managementUnit.remove = createCheckboxDropdown('managementUnitDropdownRemove', { placeholder:'Select management units', searchPlaceholder:'Search management units...' }, 'remove');
      dd.managementUnit.add    = createCheckboxDropdown('managementUnitDropdownAdd',    { placeholder:'Select management units', searchPlaceholder:'Search management units...' }, 'add');
      dd.managementUnit.change = createCheckboxDropdown('managementUnitDropdownChange', { placeholder:'Select management units', searchPlaceholder:'Search management units...' }, 'change');
      // Queues
      dd.queue.remove = createCheckboxDropdown('queueDropdownRemove', { placeholder:'Select queues', searchPlaceholder:'Search queues...' }, 'remove');
      dd.queue.add    = createCheckboxDropdown('queueDropdownAdd',    { placeholder:'Select queues', searchPlaceholder:'Search queues...' }, 'add');
      dd.queue.change = createCheckboxDropdown('queueDropdownChange', { placeholder:'Select queues', searchPlaceholder:'Search queues...' }, 'change');
    }

    function createBulkDropdowns(){
      bulkDd.remove = createCheckboxDropdown('bulkSkillRemoveDropdown', { placeholder:'Select skills to remove', searchPlaceholder:'Search skills...' });
      bulkDd.add = createCheckboxDropdown('bulkSkillAddDropdown', { placeholder:'Select skills to add', searchPlaceholder:'Search skills...' });
      bulkDd.change = createCheckboxDropdown('bulkSkillChangeDropdown', { placeholder:'Select skills to change', searchPlaceholder:'Search skills...' });
    }

    // ===== POPULATE =====
    function populateDropdowns(){
      // Agents
      const validAgents = availableUsers
        .filter(u => u.name && u.name.trim() && u.name !== 'Unknown User')
        .map(u => ({ value: u.id, label: u.name || u.email || 'Unknown User' }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      dd.agent.remove.setOptions(validAgents);
      dd.agent.add.setOptions(validAgents);
      dd.agent.change.setOptions(validAgents);

      // Skills
      const skillOpts = (availableSkills||[])
        .map(s => ({ value: s.id, label: s.name }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      dd.skill.remove.setOptions(skillOpts);
      dd.skill.add.setOptions(skillOpts);
      dd.skill.change.setOptions(skillOpts);

      // Populate bulk dropdowns
      bulkDd.remove.setOptions(skillOpts);
      bulkDd.add.setOptions(skillOpts);
      bulkDd.change.setOptions(skillOpts);

      // Teams
      const teamOpts = (availableTeams||[])
        .map(t => ({ value: t.id, label: t.name }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      dd.team.remove.setOptions(teamOpts);
      dd.team.add.setOptions(teamOpts);
      dd.team.change.setOptions(teamOpts);

      // Management Units
      const managementUnitOpts = (availableManagementUnits||[])
        .map(mu => ({ value: mu.id, label: mu.name }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      dd.managementUnit.remove.setOptions(managementUnitOpts);
      dd.managementUnit.add.setOptions(managementUnitOpts);
      dd.managementUnit.change.setOptions(managementUnitOpts);

      // Queues
      const queueOpts = (availableQueues||[])
        .map(q => ({ value: q.id, label: q.name }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      dd.queue.remove.setOptions(queueOpts);
      dd.queue.add.setOptions(queueOpts);
      dd.queue.change.setOptions(queueOpts);
    }

    // ===== SHARED SELECTIONS =====
    function updateSharedSelections(dropdownId, selectedValues, mode){
      if (dropdownId.includes('agentDropdown')) {
        sharedSelections.agentIds = selectedValues;
        // Update other agent dropdowns
        if (mode !== 'remove') dd.agent.remove.setSelectedValues(selectedValues);
        if (mode !== 'add') dd.agent.add.setSelectedValues(selectedValues);
        if (mode !== 'change') dd.agent.change.setSelectedValues(selectedValues);
      } else if (dropdownId.includes('skillDropdown')) {
        sharedSelections.skillIds = selectedValues;
        if (mode !== 'remove') dd.skill.remove.setSelectedValues(selectedValues);
        if (mode !== 'add') dd.skill.add.setSelectedValues(selectedValues);
        if (mode !== 'change') dd.skill.change.setSelectedValues(selectedValues);
      } else if (dropdownId.includes('teamDropdown')) {
        sharedSelections.teamIds = selectedValues;
        if (mode !== 'remove') dd.team.remove.setSelectedValues(selectedValues);
        if (mode !== 'add') dd.team.add.setSelectedValues(selectedValues);
        if (mode !== 'change') dd.team.change.setSelectedValues(selectedValues);
      } else if (dropdownId.includes('managementUnitDropdown')) {
        sharedSelections.managementUnitIds = selectedValues;
        if (mode !== 'remove') dd.managementUnit.remove.setSelectedValues(selectedValues);
        if (mode !== 'add') dd.managementUnit.add.setSelectedValues(selectedValues);
        if (mode !== 'change') dd.managementUnit.change.setSelectedValues(selectedValues);
      } else if (dropdownId.includes('queueDropdown')) {
        sharedSelections.queueIds = selectedValues;
        if (mode !== 'remove') dd.queue.remove.setSelectedValues(selectedValues);
        if (mode !== 'add') dd.queue.add.setSelectedValues(selectedValues);
        if (mode !== 'change') dd.queue.change.setSelectedValues(selectedValues);
      }
    }

    function syncSelectionsToCurrentTab(mode){
      // Set dropdown values based on shared selections
      dd.agent[mode].setSelectedValues(sharedSelections.agentIds);
      dd.skill[mode].setSelectedValues(sharedSelections.skillIds);
      dd.team[mode].setSelectedValues(sharedSelections.teamIds);
      dd.managementUnit[mode].setSelectedValues(sharedSelections.managementUnitIds);
      dd.queue[mode].setSelectedValues(sharedSelections.queueIds);
    }

    // ===== BULK CONTROLS =====
    function setupBulkControls(){
      // Bulk proficiency controls for Add tab
      document.getElementById('bulkProfInc').addEventListener('click', () => {
        const inp = document.getElementById('bulkProfInput');
        nudgeProf(inp, +0.5);
      });
      document.getElementById('bulkProfDec').addEventListener('click', () => {
        const inp = document.getElementById('bulkProfInput');
        nudgeProf(inp, -0.5);
      });
      document.getElementById('bulkProfInput').addEventListener('blur', () => {
        normalizeProf(document.getElementById('bulkProfInput'), true);
      });

      // Bulk proficiency controls for Change tab
      document.getElementById('bulkProfChangeInc').addEventListener('click', () => {
        const inp = document.getElementById('bulkProfChangeInput');
        nudgeProf(inp, +0.5);
      });
      document.getElementById('bulkProfChangeDec').addEventListener('click', () => {
        const inp = document.getElementById('bulkProfChangeInput');
        nudgeProf(inp, -0.5);
      });
      document.getElementById('bulkProfChangeInput').addEventListener('blur', () => {
        normalizeProf(document.getElementById('bulkProfChangeInput'), true);
      });

      // Bulk apply buttons
      document.getElementById('applyBulkRemove').addEventListener('click', applyBulkRemove);
      document.getElementById('applyBulkAdd').addEventListener('click', applyBulkAdd);
      document.getElementById('applyBulkChange').addEventListener('click', applyBulkChange);
    }

    async function applyBulkRemove(){
      const bulkSkillIds = bulkDd.remove.getSelectedValues();
      if (bulkSkillIds.length === 0) {
        showMessage('Please select at least one skill to remove from the bulk dropdown.');
        return;
      }

      const checkedBoxes = document.querySelectorAll('#userSkillsTableRemove tbody .user-checkbox-remove:checked');
      if (checkedBoxes.length === 0) {
        showMessage('Please select at least one user from the table.');
        return;
      }

      const btn = document.getElementById('applyBulkRemove');
      try {
        btn.disabled = true;
        btn.textContent = 'Processing...';
        
        const ops = [];
        checkedBoxes.forEach(cb => {
          const userId = cb.getAttribute('data-user-id');
          bulkSkillIds.forEach(skillId => {
            ops.push({ userId, skillId });
          });
        });

        const results = await Promise.allSettled(ops.map(op => apiDeleteSkill(op.userId, op.skillId)));
        const fails = results.filter(r => r.status === 'rejected');
        
        if (fails.length) {
          showMessage(`Bulk removal completed with ${fails.length} error(s).`);
        } else {
          showMessage(`Successfully removed ${bulkSkillIds.length} skill(s) from ${checkedBoxes.length} user(s).`, 'success');
        }
        
        await fetchUsers('remove');
      } catch (e) {
        showMessage(`Failed to apply bulk removal: ${e.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Apply to Selected Users';
      }
    }

    async function applyBulkAdd(){
      const bulkSkillIds = bulkDd.add.getSelectedValues();
      if (bulkSkillIds.length === 0) {
        showMessage('Please select at least one skill to add from the bulk dropdown.');
        return;
      }

      const bulkProf = parseFloat(document.getElementById('bulkProfInput').value);
      if (!validProf(bulkProf)) {
        showMessage('Please enter a valid proficiency value (1.0-5.0 in 0.5 increments).');
        return;
      }

      const checkedBoxes = document.querySelectorAll('#userSkillsTableAdd tbody .user-checkbox-add:checked');
      if (checkedBoxes.length === 0) {
        showMessage('Please select at least one user from the table.');
        return;
      }

      const btn = document.getElementById('applyBulkAdd');
      try {
        btn.disabled = true;
        btn.textContent = 'Processing...';
        
        const ops = [];
        checkedBoxes.forEach(cb => {
          const userId = cb.getAttribute('data-user-id');
          bulkSkillIds.forEach(skillId => {
            ops.push({ userId, id: skillId, proficiency: clampProf(bulkProf) });
          });
        });

        const results = await Promise.allSettled(ops.map(op => apiPostSkill(op.userId, op.id, op.proficiency)));
        const fails = results.filter(r => r.status === 'rejected');
        
        if (fails.length) {
          showMessage(`Bulk addition completed with ${fails.length} error(s).`);
        } else {
          showMessage(`Successfully added ${bulkSkillIds.length} skill(s) to ${checkedBoxes.length} user(s).`, 'success');
        }
        
        await fetchUsers('add');
      } catch (e) {
        showMessage(`Failed to apply bulk addition: ${e.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Apply to Selected Users';
      }
    }

    async function applyBulkChange(){
      const bulkSkillIds = bulkDd.change.getSelectedValues();
      if (bulkSkillIds.length === 0) {
        showMessage('Please select at least one skill to change from the bulk dropdown.');
        return;
      }

      const bulkProf = parseFloat(document.getElementById('bulkProfChangeInput').value);
      if (!validProf(bulkProf)) {
        showMessage('Please enter a valid proficiency value (1.0-5.0 in 0.5 increments).');
        return;
      }

      const checkedBoxes = document.querySelectorAll('#userSkillsTableChange tbody .user-checkbox-change:checked');
      if (checkedBoxes.length === 0) {
        showMessage('Please select at least one user from the table.');
        return;
      }

      const btn = document.getElementById('applyBulkChange');
      try {
        btn.disabled = true;
        btn.textContent = 'Processing...';
        
        const ops = [];
        checkedBoxes.forEach(cb => {
          const userId = cb.getAttribute('data-user-id');
          bulkSkillIds.forEach(skillId => {
            ops.push({ userId, id: skillId, proficiency: clampProf(bulkProf) });
          });
        });

        const results = await Promise.allSettled(ops.map(op => apiPostSkill(op.userId, op.id, op.proficiency)));
        const fails = results.filter(r => r.status === 'rejected');
        
        if (fails.length) {
          showMessage(`Bulk change completed with ${fails.length} error(s).`);
        } else {
          showMessage(`Successfully changed ${bulkSkillIds.length} skill(s) for ${checkedBoxes.length} user(s).`, 'success');
        }
        
        await fetchUsers('change');
      } catch (e) {
        showMessage(`Failed to apply bulk change: ${e.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Apply to Selected Users';
      }
    }

    // ===== EVENTS =====
    function setupEventListeners(){
      document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click', ()=>{
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
          tab.classList.add('active');
          const mode = tab.dataset.tab;
          document.getElementById(mode+'Tab').classList.add('active');
          
          // Sync selections when switching tabs
          syncSelectionsToCurrentTab(mode);
        });
      });

      document.getElementById('fetchUsersRemove').addEventListener('click', ()=> fetchUsers('remove'));
      document.getElementById('fetchUsersAdd').addEventListener('click', ()=> fetchUsers('add'));
      document.getElementById('fetchUsersChange').addEventListener('click', ()=> fetchUsers('change'));

      document.getElementById('selectAllUsersRemove').addEventListener('change', function(){
        document.querySelectorAll('#userSkillsTableRemove tbody input[type="checkbox"]').forEach(cb=>cb.checked=this.checked);
        updateRemoveButtonState();
      });
      document.getElementById('selectAllUsersAdd').addEventListener('change', function(){
        document.querySelectorAll('#userSkillsTableAdd tbody input[type="checkbox"]').forEach(cb=>cb.checked=this.checked);
        updateAddButtonState();
      });
      document.getElementById('selectAllUsersChange').addEventListener('change', function(){
        document.querySelectorAll('#userSkillsTableChange tbody input[type="checkbox"]').forEach(cb=>cb.checked=this.checked);
        updateChangeButtonState();
      });

      document.getElementById('removeSkills').addEventListener('click', ()=> removeSelectedSkills());
      document.getElementById('addSkills').addEventListener('click',    ()=> addSelectedSkills());
      document.getElementById('updateProficiency').addEventListener('click', ()=> updateSelectedProficiency());
    }

    function getSelectedAgentIds(mode){ 
      return dd.agent[mode].getSelectedValues(); 
    }
    function getSelectedSkillIds(mode){ 
      return dd.skill[mode].getSelectedValues(); 
    }
    function getSelectedTeamIds(mode){  
      return dd.team[mode].getSelectedValues();  
    }
    function getSelectedManagementUnitIds(mode){  
      return dd.managementUnit[mode].getSelectedValues();  
    }
    function getSelectedQueueIds(mode){  
      return dd.queue[mode].getSelectedValues();  
    }

    // ===== FETCH USERS + SKILLS =====
    async function fetchUsers(mode){
      const agentIds = getSelectedAgentIds(mode);
      const teamIds  = getSelectedTeamIds(mode);
      const skillIds = getSelectedSkillIds(mode);
      const managementUnitIds = getSelectedManagementUnitIds(mode);
      const queueIds = getSelectedQueueIds(mode);

      if (agentIds.length === 0 && teamIds.length === 0 && skillIds.length === 0 && managementUnitIds.length === 0 && queueIds.length === 0){
        showMessage('Please select at least one search option.');
        return;
      }

      const tbody = document.querySelector(`#userSkillsTable${cap(mode)} tbody`);
      tbody.innerHTML = '<tr><td colspan="4" class="loading">Loading users...</td></tr>';

      // Build candidate users
      let users = [];
      const validUsers = availableUsers.filter(u => u.name && u.name.trim() && u.name!=='Unknown User');

      if (agentIds.length){
        users = agentIds.map(id => validUsers.find(u=>u.id===id)).filter(Boolean);
      } else if (teamIds.length){
        const teamMembersArrays = await Promise.all(teamIds.map(tid => usersFromTeam(tid)));
        const map = new Map();
        teamMembersArrays.flat().forEach(u => map.set(u.id, u));
        users = Array.from(map.values());
      } else if (managementUnitIds.length){
        const managementUnitUsersArrays = await Promise.all(managementUnitIds.map(muid => usersFromManagementUnit(muid)));
        const map = new Map();
        managementUnitUsersArrays.flat().forEach(u => map.set(u.id, u));
        users = Array.from(map.values());
      } else if (queueIds.length){
        const queueMembersArrays = await Promise.all(queueIds.map(qid => usersFromQueue(qid)));
        const map = new Map();
        queueMembersArrays.flat().forEach(u => map.set(u.id, u));
        users = Array.from(map.values());
      } else if (skillIds.length){
        users = validUsers; // we'll filter after fetching their skills
      }

      if (!users.length){ showMessage('No users found for the selected criteria.'); return; }

      const usersWithSkills = await Promise.all(users.map(async user=>{
        const skills = await fetchUserSkills(user.id);
        return { user, skills };
      }));

      // Filter by selected skills:
      let filtered;
      if (skillIds.length){
        const hasAny = (skills)=> skills.some(s => skillIds.includes(s.id));
        const hasAll = (skills)=> skillIds.every(id => skills.some(s=>s.id===id));
        if (mode==='remove' || mode==='change'){
          // Keep users who have ANY of the selected skills
          filtered = usersWithSkills.filter(({skills})=> hasAny(skills));
        } else {
          // add: keep users who are missing AT LEAST one selected skill
          filtered = usersWithSkills.filter(({skills})=> !hasAll(skills));
        }
      } else {
        filtered = usersWithSkills;
      }

      if (mode==='remove') populateRemoveTable(filtered);
      else if (mode==='add') populateAddTable(filtered, skillIds);
      else populateChangeTable(filtered, skillIds);
    }

    async function usersFromTeam(teamId){
      const res = await fetch(`https://api.mypurecloud.ie/api/v2/teams/${teamId}/members`, { headers: authHeaders() });
      if (!res.ok) throw new Error((await safeJson(res))?.message || `Failed to fetch team ${teamId} members`);
      const data = await res.json();
      const members = data.entities || [];
      const validUsers = availableUsers.filter(u => u.name && u.name.trim() && u.name!=='Unknown User');
      return members.map(m => validUsers.find(u=>u.id===m.id)).filter(Boolean);
    }

    async function usersFromManagementUnit(managementUnitId){
      let allUsers = [], page=1, size=100, total=0;
      do{
        const res = await fetch(`https://api.mypurecloud.ie/api/v2/workforcemanagement/managementunits/${managementUnitId}/users?pageNumber=${page}&pageSize=${size}`, { headers: authHeaders() });
        if (!res.ok) throw new Error((await safeJson(res))?.message || `Failed to fetch management unit ${managementUnitId} users`);
        const data = await res.json();
        allUsers = allUsers.concat(data.entities || []);
        total = data.total || 0; page++;
      } while (allUsers.length < total);
      
      const validUsers = availableUsers.filter(u => u.name && u.name.trim() && u.name!=='Unknown User');
      return allUsers.map(muUser => validUsers.find(u=>u.id===muUser.id)).filter(Boolean);
    }

    async function usersFromQueue(queueId){
      let allMembers = [], page=1, size=100, totalMembers=0;
      do{
        const res = await fetch(`https://api.mypurecloud.ie/api/v2/routing/queues/${queueId}/members?pageNumber=${page}&pageSize=${size}`, { headers: authHeaders() });
        if (!res.ok) throw new Error((await safeJson(res))?.message || `Failed to fetch members for queue ${queueId}`);
        const data = await res.json();
        allMembers = allMembers.concat(data.entities || []);
        totalMembers = data.total || 0; page++;
      } while (allMembers.length < totalMembers);
      
      const validUsers = availableUsers.filter(u => u.name && u.name.trim() && u.name!=='Unknown User');
      return allMembers.map(member => {
        const userId = member.user?.id;
        return userId ? validUsers.find(u=>u.id===userId) : null;
      }).filter(Boolean);
    }

    async function fetchUserSkills(userId){
      const url = `https://api.mypurecloud.ie/api/v2/users/${userId}/routingskills`;
      try{
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok){
          if (res.status===404) return [];
          console.warn(`Failed to fetch skills for ${userId}:`, res.status);
          return [];
        }
        const data = await res.json();
        const list = Array.isArray(data) ? data : (data.entities || []);
        return (list||[]).map(s => ({
          id: s.id,
          name: s.name || (availableSkills.find(as=>as.id===s.id)?.name) || 'Unknown Skill',
          proficiency: (typeof s.proficiency==='number') ? s.proficiency : null
        }));
      } catch(e){
        console.error(`Error fetching skills for ${userId}:`, e);
        return [];
      }
    }

    // ===== TABLES =====
    function populateRemoveTable(rows){
      const tbody = document.querySelector('#userSkillsTableRemove tbody');
      tbody.innerHTML='';
      if (!rows.length){ tbody.innerHTML='<tr><td colspan="4">No users found.</td></tr>'; updateRemoveButtonState(); return; }

      rows.forEach(({user, skills})=>{
        const assignedText = skills.length
          ? skills.map(s=> `${s.name}${s.proficiency!=null?` (${s.proficiency.toFixed(1)})`:''}`).join(', ')
          : 'No Skills';
        const options = skills.length
          ? ['<option value="">Select Skill to Remove</option>', ...skills.map(s=> `<option value="${s.id}">${s.name}${s.proficiency!=null?` (${s.proficiency.toFixed(1)})`:''}</option>`)].join('')
          : '<option value="">No Skills Assigned</option>';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" data-user-id="${user.id}" class="user-checkbox-remove"></td>
          <td>${user.name}</td>
          <td>${assignedText}</td>
          <td><select data-user-id="${user.id}" class="skill-select-remove" ${skills.length?'':'disabled'}>${options}</select></td>
        `;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('.user-checkbox-remove').forEach(cb=>cb.addEventListener('change', updateRemoveButtonState));
      document.querySelectorAll('.skill-select-remove').forEach(sel=>sel.addEventListener('change', updateRemoveButtonState));
      updateRemoveButtonState();
    }

    function populateAddTable(rows, selectedSkillIds=[]){
      const tbody = document.querySelector('#userSkillsTableAdd tbody');
      tbody.innerHTML='';
      if (!rows.length){ tbody.innerHTML='<tr><td colspan="4">No users found.</td></tr>'; updateAddButtonState(); return; }

      rows.forEach(({user, skills})=>{
        const assignedIds = skills.map(s=>s.id);
        const choices = availableSkills.filter(s => !assignedIds.includes(s.id));
        // Preselect the first selected-skill that user doesn't have, else blank
        const preselect = selectedSkillIds.find(id => choices.some(c=>c.id===id)) || '';

        const options = choices.length
          ? ['<option value="">Select Skill to Add</option>', ...choices.map(s=> `<option value="${s.id}" ${s.id===preselect?'selected':''}>${s.name}</option>`)].join('')
          : '<option value="">All Skills Assigned</option>';

        const assignedText = skills.length
          ? skills.map(s=> `${s.name}${s.proficiency!=null?` (${s.proficiency.toFixed(1)})`:''}`).join(', ')
          : 'No Skills';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" data-user-id="${user.id}" class="user-checkbox-add"></td>
          <td>${user.name}</td>
          <td>${assignedText}</td>
          <td>
            <div style="display:grid;grid-template-columns:minmax(220px,1fr) auto;gap:12px;align-items:center;">
              <select data-user-id="${user.id}" class="skill-select-add" ${choices.length?'':'disabled'}>${options}</select>
              <div class="prof-wrap">
                <button type="button" class="tiny-btn" data-act="dec" data-user-id="${user.id}">−</button>
                <input type="number" step="0.5" min="1" max="5" value="3.0" class="prof-input" data-user-id="${user.id}" ${choices.length?'':'disabled'} />
                <button type="button" class="tiny-btn" data-act="inc" data-user-id="${user.id}">+</button>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.user-checkbox-add').forEach(cb=>cb.addEventListener('change', updateAddButtonState));
      document.querySelectorAll('.skill-select-add').forEach(sel=>sel.addEventListener('change', updateAddButtonState));
      document.querySelectorAll('.prof-input').forEach(inp=>{
        inp.addEventListener('input', ()=>{ normalizeProf(inp); updateAddButtonState(); });
        inp.addEventListener('blur',  ()=>{ normalizeProf(inp,true); updateAddButtonState(); });
      });
      document.querySelectorAll('[data-act="inc"]').forEach(btn=>btn.addEventListener('click', ()=>{
        const inp = document.querySelector(`.prof-input[data-user-id="${btn.dataset.userId}"]`);
        nudgeProf(inp, +0.5); updateAddButtonState();
      }));
      document.querySelectorAll('[data-act="dec"]').forEach(btn=>btn.addEventListener('click', ()=>{
        const inp = document.querySelector(`.prof-input[data-user-id="${btn.dataset.userId}"]`);
        nudgeProf(inp, -0.5); updateAddButtonState();
      }));
      updateAddButtonState();
    }

    function populateChangeTable(rows, selectedSkillIds=[]){
      const tbody = document.querySelector('#userSkillsTableChange tbody');
      tbody.innerHTML='';
      if (!rows.length){ tbody.innerHTML='<tr><td colspan="4">No users found.</td></tr>'; updateChangeButtonState(); return; }

      rows.forEach(({user, skills})=>{
        const assignedText = skills.length
          ? skills.map(s=> `${s.name}${s.proficiency!=null?` (${s.proficiency.toFixed(1)})`:''}`).join(', ')
          : 'No Skills';

        // Default selection: first of selectedSkillIds that the user has; else first skill
        let selectedSkill = skills[0] || null;
        if (selectedSkillIds.length){
          const match = skills.find(s => selectedSkillIds.includes(s.id));
          if (match) selectedSkill = match;
        }
        const initialProf = selectedSkill && typeof selectedSkill.proficiency==='number' ? selectedSkill.proficiency : 3.0;

        const options = skills.map(s=> `
          <option value="${s.id}" data-prof="${s.proficiency!=null?s.proficiency:''}" ${selectedSkill && selectedSkill.id===s.id?'selected':''}>
            ${s.name}${s.proficiency!=null?` (${s.proficiency.toFixed(1)})`:''}
          </option>`).join('');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" data-user-id="${user.id}" class="user-checkbox-change" ${skills.length?'':'disabled'}></td>
          <td>${user.name}</td>
          <td>${assignedText}</td>
          <td>
            ${
              skills.length
                ? `<div style="display:grid;grid-template-columns:minmax(220px,1fr) auto;gap:12px;align-items:center;">
                     <select data-user-id="${user.id}" class="skill-select-change">${options}</select>
                     <div class="prof-wrap">
                       <button type="button" class="tiny-btn" data-act="dec-change" data-user-id="${user.id}">−</button>
                       <input type="number" step="0.5" min="1" max="5" value="${initialProf.toFixed(1)}" class="prof-input-change" data-user-id="${user.id}"/>
                       <button type="button" class="tiny-btn" data-act="inc-change" data-user-id="${user.id}">+</button>
                     </div>
                   </div>`
                : `<span class="muted">No direct skills to change</span>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.skill-select-change').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const uid = sel.getAttribute('data-user-id');
          const prof = parseFloat(sel.selectedOptions[0]?.dataset?.prof ?? '3.0');
          const inp = document.querySelector(`.prof-input-change[data-user-id="${uid}"]`);
          if (inp) inp.value = clampProf(prof).toFixed(1);
          updateChangeButtonState();
        });
      });
      document.querySelectorAll('.prof-input-change').forEach(inp=>{
        inp.addEventListener('input', ()=>{ normalizeProf(inp); updateChangeButtonState(); });
        inp.addEventListener('blur',  ()=>{ normalizeProf(inp,true); updateChangeButtonState(); });
      });
      document.querySelectorAll('[data-act="inc-change"]').forEach(btn=>btn.addEventListener('click', ()=>{
        const inp = document.querySelector(`.prof-input-change[data-user-id="${btn.dataset.userId}"]`);
        nudgeProf(inp, +0.5); updateChangeButtonState();
      }));
      document.querySelectorAll('[data-act="dec-change"]').forEach(btn=>btn.addEventListener('click', ()=>{
        const inp = document.querySelector(`.prof-input-change[data-user-id="${btn.dataset.userId}"]`);
        nudgeProf(inp, -0.5); updateChangeButtonState();
      }));
      document.querySelectorAll('.user-checkbox-change').forEach(cb=>cb.addEventListener('change', updateChangeButtonState));
      updateChangeButtonState();
    }

    // ===== BUTTON STATES =====
    function updateRemoveButtonState(){
      const btn = document.getElementById('removeSkills');
      const checked = [...document.querySelectorAll('.user-checkbox-remove:checked')];
      let ok=false;
      checked.forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-remove[data-user-id="${uid}"]`);
        if (sel && sel.value) ok=true;
      });
      btn.disabled = !(checked.length>0 && ok);
    }
    function updateAddButtonState(){
      const btn = document.getElementById('addSkills');
      const checked = [...document.querySelectorAll('.user-checkbox-add:checked')];
      let ok = checked.length>0;
      checked.forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-add[data-user-id="${uid}"]`);
        const inp = document.querySelector(`.prof-input[data-user-id="${uid}"]`);
        if (!sel || !sel.value) ok=false;
        if (!inp || !validProf(inp.value)) ok=false;
      });
      btn.disabled = !ok;
    }
    function updateChangeButtonState(){
      const btn = document.getElementById('updateProficiency');
      const checked = [...document.querySelectorAll('.user-checkbox-change:checked')];
      let ok = checked.length>0;
      checked.forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-change[data-user-id="${uid}"]`);
        const inp = document.querySelector(`.prof-input-change[data-user-id="${uid}"]`);
        if (!sel || !sel.value) ok=false;
        if (!inp || !validProf(inp.value)) ok=false;
      });
      btn.disabled = !ok;
    }

    // ===== ACTIONS =====
    async function removeSelectedSkills(){
      const ops = [];
      document.querySelectorAll('.user-checkbox-remove:checked').forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-remove[data-user-id="${uid}"]`);
        if (sel && sel.value) ops.push({ userId: uid, skillId: sel.value });
      });
      if (!ops.length){ showMessage('No valid operations to perform.'); return; }

      const btn = document.getElementById('removeSkills');
      try{
        btn.disabled=true; btn.textContent='Processing...';
        const results = await Promise.allSettled(ops.map(op => apiDeleteSkill(op.userId, op.skillId)));
        const fails = results.filter(r=>r.status==='rejected');
        if (fails.length) showMessage(`Completed with ${fails.length} error(s). Check console.`);
        else showMessage('All skill removals completed successfully!','success');
        await fetchUsers('remove');
      } catch(e){ showMessage(`Failed to remove skills: ${e.message}`); }
      finally{ btn.disabled=false; btn.textContent='Remove Selected Skills from Selected Users'; }
    }

    async function addSelectedSkills(){
      const ops = [];
      document.querySelectorAll('.user-checkbox-add:checked').forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-add[data-user-id="${uid}"]`);
        const inp = document.querySelector(`.prof-input[data-user-id="${uid}"]`);
        if (sel && sel.value && validProf(inp.value)) ops.push({ userId: uid, id: sel.value, proficiency: clampProf(parseFloat(inp.value)) });
      });
      if (!ops.length){ showMessage('No valid operations to perform.'); return; }

      const btn = document.getElementById('addSkills');
      try{
        btn.disabled=true; btn.textContent='Processing...';
        const results = await Promise.allSettled(ops.map(op => apiPostSkill(op.userId, op.id, op.proficiency)));
        const fails = results.filter(r=>r.status==='rejected');
        if (fails.length) showMessage(`Completed with ${fails.length} error(s). Check console.`);
        else showMessage('All skill additions completed successfully!','success');
        await fetchUsers('add');
      } catch(e){ showMessage(`Failed to add skills: ${e.message}`); }
      finally{ btn.disabled=false; btn.textContent='Add Selected Skills to Selected Users'; }
    }

    async function updateSelectedProficiency(){
      const ops = [];
      document.querySelectorAll('.user-checkbox-change:checked').forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-change[data-user-id="${uid}"]`);
        const inp = document.querySelector(`.prof-input-change[data-user-id="${uid}"]`);
        if (sel && sel.value && validProf(inp.value)) ops.push({ userId: uid, id: sel.value, proficiency: clampProf(parseFloat(inp.value)) });
      });
      if (!ops.length){ showMessage('No valid operations to perform.'); return; }

      const btn = document.getElementById('updateProficiency');
      try{
        btn.disabled=true; btn.textContent='Processing...';
        const results = await Promise.allSettled(ops.map(op => apiPostSkill(op.userId, op.id, op.proficiency))); // POST updates proficiency
        const fails = results.filter(r=>r.status==='rejected');
        if (fails.length) showMessage(`Completed with ${fails.length} error(s). Check console.`);
        else showMessage('Proficiency updated successfully!','success');
        await fetchUsers('change');
      } catch(e){ showMessage(`Failed to update proficiency: ${e.message}`); }
      finally{ btn.disabled=false; btn.textContent='Update Proficiency for Selected'; }
    }

    // ===== API HELPERS =====
    async function apiDeleteSkill(userId, skillId){
      const res = await fetch(`https://api.mypurecloud.ie/api/v2/users/${userId}/routingskills/${skillId}`, { method:'DELETE', headers: authHeaders() });
      if (!res.ok) throw new Error((await safeJson(res))?.message || `Failed to remove skill`);
      return true;
    }
    async function apiPostSkill(userId, skillId, proficiency){
      const res = await fetch(`https://api.mypurecloud.ie/api/v2/users/${userId}/routingskills`, {
        method:'POST', headers: authHeaders(), body: JSON.stringify({ id: skillId, proficiency: Number(proficiency) })
      });
      if (!res.ok) throw new Error((await safeJson(res))?.message || `Failed to set skill`);
      return true;
    }

    // ===== PROF HELPERS =====
    function normalizeProf(inp, snap=false){
      let v = parseFloat(inp.value);
      if (Number.isNaN(v)) { inp.value=''; return; }
      if (snap) v = Math.round(v*2)/2;
      v = Math.min(5, Math.max(1, v));
      inp.value = v.toFixed(1);
    }
    function nudgeProf(inp, delta){
      let v = parseFloat(inp.value); if (Number.isNaN(v)) v = 3.0;
      v = Math.round((v + delta)*2)/2; v = Math.min(5, Math.max(1, v));
      inp.value = v.toFixed(1);
    }
    function validProf(v){ 
      const n = parseFloat(v); 
      return !Number.isNaN(n) && n>=1 && n<=5 && Math.abs(n*2 - Math.round(n*2)) < 1e-9; 
    }
    function clampProf(v){ return Math.min(5, Math.max(1, v)); }
  </script>
</body>
</html>
