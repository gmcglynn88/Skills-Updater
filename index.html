<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPI Skill Updates</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{font-family:'Segoe UI',Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg);font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;align-items:end}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .loading{opacity:.6;pointer-events:none}
    .selection-section{margin-bottom:20px;padding:15px;border:1px solid var(--border-color);border-radius:8px;background-color:var(--light-bg)}
    .selection-section h3{margin-top:0;color:var(--primary-color)}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid var(--border-color);padding:10px;text-align:left;vertical-align:top}
    th{background-color:var(--primary-color);color:#fff}
    .select-all-checkbox{margin-bottom:10px}
    .error-message{color:#d9534f;padding:10px;margin:10px 0;border:1px solid #d9534f;border-radius:4px;background:#f9f2f2}
    .success-message{color:#3c763d;padding:10px;margin:10px 0;border:1px solid #3c763d;border-radius:4px;background:#dff0d8}
    .tab-container{display:flex;margin-bottom:20px;border-bottom:1px solid var(--border-color)}
    .tab{padding:12px 24px;cursor:pointer;border:1px solid var(--border-color);border-bottom:none;border-radius:8px 8px 0 0;margin-right:4px;background:var(--light-bg);transition:background .2s}
    .tab.active{background:var(--primary-color);color:white;border-color:var(--primary-color)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .prof-wrap{display:flex;gap:8px;align-items:center;margin-top:6px}
    .prof-input{width:90px}
    .tiny-btn{padding:8px 10px;font-size:14px;line-height:1}
    .muted{color:var(--text-light);font-size:12px}
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>
  <h1>Skill Management Tool</h1>

  <div id="loginSection" class="card" style="text-align: center; margin: 20px;">
    <div class="loading">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer" style="display:none;"></div>

    <div class="tab-container">
      <div class="tab active" data-tab="remove">Remove Skills</div>
      <div class="tab" data-tab="add">Add Skills</div>
      <div class="tab" data-tab="change">Change Proficiency</div>
    </div>

    <!-- Remove Skills Tab -->
    <div id="removeTab" class="tab-content active">
      <div class="selection-section">
        <h3>Search Options</h3>
        <div class="controls">
          <div>
            <label for="agentDropdownRemove">Select Agents</label>
            <select id="agentDropdownRemove" multiple class="multi-select">
              <option value="">Loading agents...</option>
            </select>
          </div>
          <div>
            <label for="skillDropdownRemove">Select Skill</label>
            <select id="skillDropdownRemove">
              <option value="">Select Skill</option>
            </select>
          </div>
          <div>
            <label for="teamDropdownRemove">Select Work Team</label>
            <select id="teamDropdownRemove">
              <option value="">Select Team</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="fetchUsersRemove" class="full-width-btn">Get Users</button>
          </div>
        </div>
        <div class="muted">Tip: If you only pick a Skill, I’ll scan all agents and show only those who have it.</div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 12px;">Routing Skills — Remove</h2>
        <table id="userSkillsTableRemove">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsersRemove" class="select-all-checkbox"></th>
              <th>Agent</th>
              <th>Skills Assigned</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button id="removeSkills" class="full-width-btn" disabled>Remove Selected Skills from Selected Users</button>
      </div>
    </div>

    <!-- Add Skills Tab -->
    <div id="addTab" class="tab-content">
      <div class="selection-section">
        <h3>Search Options</h3>
        <div class="controls">
          <div>
            <label for="agentDropdownAdd">Select Agents</label>
            <select id="agentDropdownAdd" multiple class="multi-select">
              <option value="">Loading agents...</option>
            </select>
          </div>
          <div>
            <label for="skillDropdownAdd">Select Skill</label>
            <select id="skillDropdownAdd">
              <option value="">Select Skill</option>
            </select>
          </div>
          <div>
            <label for="teamDropdownAdd">Select Work Team</label>
            <select id="teamDropdownAdd">
              <option value="">Select Team</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="fetchUsersAdd" class="full-width-btn">Get Users</button>
          </div>
        </div>
        <div class="muted">Proficiency can be typed or nudged in ±0.5 steps (min 1, max 5).</div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 12px;">Routing Skills — Add</h2>
        <table id="userSkillsTableAdd">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsersAdd" class="select-all-checkbox"></th>
              <th>Agent</th>
              <th>Skills Assigned</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button id="addSkills" class="full-width-btn" disabled>Add Selected Skills to Selected Users</button>
      </div>
    </div>

    <!-- Change Proficiency Tab -->
    <div id="changeTab" class="tab-content">
      <div class="selection-section">
        <h3>Search Options</h3>
        <div class="controls">
          <div>
            <label for="agentDropdownChange">Select Agents</label>
            <select id="agentDropdownChange" multiple class="multi-select">
              <option value="">Loading agents...</option>
            </select>
          </div>
          <div>
            <label for="skillDropdownChange">Filter by Skill (optional)</label>
            <select id="skillDropdownChange">
              <option value="">Any Skill</option>
            </select>
          </div>
          <div>
            <label for="teamDropdownChange">Select Work Team</label>
            <select id="teamDropdownChange">
              <option value="">Select Team</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="fetchUsersChange" class="full-width-btn">Get Users</button>
          </div>
        </div>
        <div class="muted">Pick users, then adjust the proficiency for the chosen skill. Clicky-click to nudge ±0.5.</div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 12px;">Routing Skills — Change Proficiency</h2>
        <table id="userSkillsTableChange">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsersChange" class="select-all-checkbox"></th>
              <th>Agent</th>
              <th>Skills Assigned</th>
              <th>Change To</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button id="updateProficiency" class="full-width-btn" disabled>Update Proficiency for Selected</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const clientId = 'd4529142-7340-4cd8-a9f9-f3a4d25670df';
    const redirectUri = 'https://gmcglynn88.github.io/Skills-Updater/';
    const responseType = 'token';
    const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=${responseType}&redirect_uri=${encodeURIComponent(redirectUri)}`;

    // ===== State =====
    let token = null;
    let availableUsers = [];
    let availableTeams = [];
    let availableSkills = [];

    // ===== Boot =====
    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      token = params.get('access_token');

      if (token) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        initializeApp();
      } else {
        window.location.href = oauthUrl;
      }
    });

    function showMessage(message, type = 'error') {
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${message}</div>`;
      box.style.display = 'block';
      if (type === 'success') setTimeout(() => box.style.display = 'none', 5000);
    }

    // ===== Init =====
    async function initializeApp() {
      try {
        await Promise.all([fetchAllUsers(), fetchAllTeams(), fetchAllSkills()]);
        populateDropdowns();
        setupEvents();
      } catch (err) {
        console.error('Init error:', err);
        showMessage('Error initializing application. Please try again.');
        setTimeout(() => (window.location.href = oauthUrl), 3000);
      }
    }

    // ===== Fetch lists =====
    async function fetchAllUsers() {
      let all=[], page=1, size=100, total=0;
      do {
        const url = `https://api.mypurecloud.ie/api/v2/users?pageNumber=${page}&pageSize=${size}`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error((await safeJson(res))?.message || 'Failed to fetch users');
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0; page++;
      } while (all.length < total);
      availableUsers = all;
    }

    async function fetchAllTeams() {
      let all=[], page=1, size=100, total=0;
      do {
        const url = `https://api.mypurecloud.ie/api/v2/teams?pageNumber=${page}&pageSize=${size}`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error((await safeJson(res))?.message || 'Failed to fetch teams');
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0; page++;
      } while (all.length < total);
      availableTeams = all;
    }

    async function fetchAllSkills() {
      let all=[], page=1, size=100, total=0;
      do {
        const url = `https://api.mypurecloud.ie/api/v2/routing/skills?pageNumber=${page}&pageSize=${size}`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error((await safeJson(res))?.message || 'Failed to fetch skills');
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0; page++;
      } while (all.length < total);
      availableSkills = all;
    }

    function authHeaders(){ return { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }; }
    async function safeJson(res){ try{ return await res.json(); } catch{ return null; } }

    // ===== Dropdowns =====
    function populateDropdowns(){
      // Agents for all tabs
      ['Remove','Add','Change'].forEach(suffix => populateAgentDropdown('agentDropdown'+suffix));
      // Teams for all tabs
      ['Remove','Add','Change'].forEach(suffix => populateTeamDropdown('teamDropdown'+suffix));
      // Skills for all tabs
      ['Remove','Add','Change'].forEach(suffix => populateSkillDropdown('skillDropdown'+suffix, suffix==='Change' ? 'Any Skill' : 'Select Skill'));
    }

    function populateAgentDropdown(id){
      const el = document.getElementById(id);
      el.innerHTML = '';
      const users = availableUsers.filter(u => u.name && u.name.trim() && u.name !== 'Unknown User');
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = u.name || u.email || 'Unknown User';
        el.appendChild(opt);
      });
    }

    function populateTeamDropdown(id){
      const el = document.getElementById(id);
      el.innerHTML = '<option value="">Select Team</option>';
      availableTeams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id; opt.textContent = t.name;
        el.appendChild(opt);
      });
    }

    function populateSkillDropdown(id, first='Select Skill'){
      const el = document.getElementById(id);
      el.innerHTML = `<option value="">${first}</option>`;
      availableSkills.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id; opt.textContent = s.name;
        el.appendChild(opt);
      });
    }

    // ===== Events =====
    function setupEvents(){
      // tab switch
      document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click',()=>{
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab+'Tab').classList.add('active');
        });
      });

      // fetch buttons
      document.getElementById('fetchUsersRemove').addEventListener('click',()=>fetchUsers('remove'));
      document.getElementById('fetchUsersAdd').addEventListener('click',()=>fetchUsers('add'));
      document.getElementById('fetchUsersChange').addEventListener('click',()=>fetchUsers('change'));

      // bulk select
      document.getElementById('selectAllUsersRemove').addEventListener('change', function(){
        document.querySelectorAll('#userSkillsTableRemove tbody input[type="checkbox"]').forEach(cb=>cb.checked=this.checked);
        updateRemoveButtonState();
      });
      document.getElementById('selectAllUsersAdd').addEventListener('change', function(){
        document.querySelectorAll('#userSkillsTableAdd tbody input[type="checkbox"]').forEach(cb=>cb.checked=this.checked);
        updateAddButtonState();
      });
      document.getElementById('selectAllUsersChange').addEventListener('change', function(){
        document.querySelectorAll('#userSkillsTableChange tbody input[type="checkbox"]').forEach(cb=>cb.checked=this.checked);
        updateChangeButtonState();
      });

      // action buttons
      document.getElementById('removeSkills').addEventListener('click',()=>removeSelectedSkills());
      document.getElementById('addSkills').addEventListener('click',()=>addSelectedSkills());
      document.getElementById('updateProficiency').addEventListener('click',()=>updateSelectedProficiency());
    }

    // ===== Fetch users & their skills =====
    async function fetchUsers(mode){
      const agentIds = Array.from(document.getElementById(`agentDropdown${cap(mode)}`).selectedOptions).map(o=>o.value);
      const teamId = document.getElementById(`teamDropdown${cap(mode)}`).value;
      const skillId = document.getElementById(`skillDropdown${cap(mode)}`).value;

      if (agentIds.length === 0 && !teamId && !skillId){
        showMessage('Please select at least one search option.');
        return;
      }

      const tbody = document.querySelector(`#userSkillsTable${cap(mode)} tbody`);
      tbody.innerHTML = '<tr><td colspan="4" class="loading">Loading users...</td></tr>';

      let users = [];
      if (agentIds.length){
        users = agentIds.map(id => availableUsers.find(u=>u.id===id)).filter(Boolean);
      } else if (teamId){
        users = await usersFromTeam(teamId);
      } else if (skillId){
        // scan all valid users (then filter after loading skills)
        users = availableUsers.filter(u => u.name && u.name.trim() && u.name !== 'Unknown User');
      }

      if (!users.length){
        showMessage('No users found for the selected criteria.');
        return;
      }

      const usersWithSkills = await Promise.all(users.map(async user=>{
        const skills = await fetchUserSkills(user.id);
        return { user, skills };
      }));

      // Filter by selected skill where appropriate
      let filtered = usersWithSkills;
      if (skillId){
        const hasSkill = (skills)=>skills.some(s=>s.id===skillId);
        if (mode==='remove' || mode==='change') filtered = usersWithSkills.filter(({skills})=>hasSkill(skills));
        if (mode==='add') filtered = usersWithSkills.filter(({skills})=>!hasSkill(skills));
      }

      if (mode==='remove') populateRemoveTable(filtered);
      else if (mode==='add') populateAddTable(filtered, skillId);
      else populateChangeTable(filtered, skillId);
    }

    async function usersFromTeam(teamId){
      const url = `https://api.mypurecloud.ie/api/v2/teams/${teamId}/members`;
      const res = await fetch(url, { headers: authHeaders() });
      if (!res.ok) throw new Error((await safeJson(res))?.message || `Failed to fetch team ${teamId} members`);
      const data = await res.json();
      const members = data.entities || [];
      return members
        .map(m => availableUsers.find(u=>u.id===m.id))
        .filter(u => u && u.name && u.name.trim() && u.name!=='Unknown User');
    }

    // Direct skills
    async function fetchUserSkills(userId){
      const url = `https://api.mypurecloud.ie/api/v2/users/${userId}/routingskills`;
      try{
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok){
          if (res.status === 404) return [];
          console.warn(`Skill fetch ${userId} failed:`, res.status);
          return [];
        }
        const data = await res.json();
        const list = Array.isArray(data) ? data : (data.entities || []);
        return (list || []).map(s => ({
          id: s.id,
          name: s.name || (availableSkills.find(as=>as.id===s.id)?.name) || 'Unknown Skill',
          proficiency: (typeof s.proficiency === 'number') ? s.proficiency : null
        }));
      } catch (e){
        console.error(`Error fetching skills for ${userId}:`, e);
        return [];
      }
    }

    // ===== Table builders =====
    function populateRemoveTable(rows){
      const tbody = document.querySelector('#userSkillsTableRemove tbody');
      tbody.innerHTML = '';
      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="4">No users found.</td></tr>'; updateRemoveButtonState(); return;
      }
      rows.forEach(({user, skills})=>{
        const assignedText = skills.length
          ? skills.map(s => `${s.name}${s.proficiency!=null?` (${s.proficiency.toFixed(1)})`:``}`).join(', ')
          : 'No Skills';

        const options = skills.length
          ? ['<option value="">Select Skill to Remove</option>', ...skills.map(s => `<option value="${s.id}">${s.name}${s.proficiency!=null?` (${s.proficiency.toFixed(1)})`:''}</option>`)].join('')
          : '<option value="">No Skills Assigned</option>';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" data-user-id="${user.id}" class="user-checkbox-remove"></td>
          <td>${user.name}</td>
          <td>${assignedText}</td>
          <td>
            <select data-user-id="${user.id}" class="skill-select-remove" ${skills.length?'':'disabled'}>
              ${options}
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.user-checkbox-remove').forEach(cb => cb.addEventListener('change', updateRemoveButtonState));
      document.querySelectorAll('.skill-select-remove').forEach(sel => sel.addEventListener('change', updateRemoveButtonState));
      updateRemoveButtonState();
    }

    function populateAddTable(rows, preselectedSkillId=''){
      const tbody = document.querySelector('#userSkillsTableAdd tbody');
      tbody.innerHTML = '';
      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="4">No users found.</td></tr>'; updateAddButtonState(); return;
      }

      rows.forEach(({user, skills})=>{
        const assignedIds = skills.map(s=>s.id);
        const choices = availableSkills.filter(s => !assignedIds.includes(s.id));
        const options = choices.length
          ? ['<option value="">Select Skill to Add</option>', ...choices.map(s => `<option value="${s.id}" ${s.id===preselectedSkillId?'selected':''}>${s.name}</option>`)].join('')
          : '<option value="">All Skills Assigned</option>';

        const assignedText = skills.length
          ? skills.map(s => `${s.name}${s.proficiency!=null?` (${s.proficiency.toFixed(1)})`:``}`).join(', ')
          : 'No Skills';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" data-user-id="${user.id}" class="user-checkbox-add"></td>
          <td>${user.name}</td>
          <td>${assignedText}</td>
          <td>
            <div style="display:grid;grid-template-columns:minmax(220px,1fr) auto;gap:12px;align-items:center;">
              <select data-user-id="${user.id}" class="skill-select-add" ${choices.length?'':'disabled'}>${options}</select>
              <div class="prof-wrap">
                <button type="button" class="tiny-btn" data-act="dec" data-user-id="${user.id}">−</button>
                <input type="number" step="0.5" min="1" max="5" value="3.0" class="prof-input" data-user-id="${user.id}" ${choices.length?'':'disabled'} />
                <button type="button" class="tiny-btn" data-act="inc" data-user-id="${user.id}">+</button>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.user-checkbox-add').forEach(cb => cb.addEventListener('change', updateAddButtonState));
      document.querySelectorAll('.skill-select-add').forEach(sel => sel.addEventListener('change', updateAddButtonState));
      document.querySelectorAll('.prof-input').forEach(inp => {
        inp.addEventListener('input', ()=>{ normalizeProf(inp); updateAddButtonState(); });
        inp.addEventListener('blur', ()=>{ normalizeProf(inp,true); updateAddButtonState(); });
      });
      document.querySelectorAll('[data-act="inc"]').forEach(btn => btn.addEventListener('click', ()=>{
        const inp = document.querySelector(`.prof-input[data-user-id="${btn.dataset.userId}"]`);
        nudgeProf(inp, +0.5); updateAddButtonState();
      }));
      document.querySelectorAll('[data-act="dec"]').forEach(btn => btn.addEventListener('click', ()=>{
        const inp = document.querySelector(`.prof-input[data-user-id="${btn.dataset.userId}"]`);
        nudgeProf(inp, -0.5); updateAddButtonState();
      }));
      updateAddButtonState();
    }

    function populateChangeTable(rows, preselectedSkillId=''){
      const tbody = document.querySelector('#userSkillsTableChange tbody');
      tbody.innerHTML = '';
      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="4">No users found.</td></tr>'; updateChangeButtonState(); return;
      }

      rows.forEach(({user, skills})=>{
        const direct = skills; // already direct skills
        const assignedText = direct.length
          ? direct.map(s => `${s.name}${s.proficiency!=null?` (${s.proficiency.toFixed(1)})`:``}`).join(', ')
          : 'No Skills';

        const options = direct.length
          ? direct.map(s => `<option value="${s.id}" data-prof="${s.proficiency!=null?s.proficiency:''}" ${preselectedSkillId && preselectedSkillId===s.id?'selected':''}>${s.name}${s.proficiency!=null?` (${s.proficiency.toFixed(1)})`:''}</option>`).join('')
          : '';

        // Determine initial selection and prof
        let initialProf = 3.0;
        if (direct.length){
          const selectedSkill = preselectedSkillId ? direct.find(s=>s.id===preselectedSkillId) : direct[0];
          if (selectedSkill && typeof selectedSkill.proficiency==='number') initialProf = selectedSkill.proficiency;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" data-user-id="${user.id}" class="user-checkbox-change" ${direct.length?'':'disabled'}></td>
          <td>${user.name}</td>
          <td>${assignedText}</td>
          <td>
            ${
              direct.length
              ? `<div style="display:grid;grid-template-columns:minmax(220px,1fr) auto;gap:12px;align-items:center;">
                  <select data-user-id="${user.id}" class="skill-select-change">${options}</select>
                  <div class="prof-wrap">
                    <button type="button" class="tiny-btn" data-act="dec-change" data-user-id="${user.id}">−</button>
                    <input type="number" step="0.5" min="1" max="5" value="${initialProf.toFixed(1)}" class="prof-input-change" data-user-id="${user.id}"/>
                    <button type="button" class="tiny-btn" data-act="inc-change" data-user-id="${user.id}">+</button>
                  </div>
                </div>`
              : `<span class="muted">No direct skills to change</span>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Sync selected skill -> input value
      document.querySelectorAll('.skill-select-change').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const uid = sel.getAttribute('data-user-id');
          const opt = sel.selectedOptions[0];
          const prof = parseFloat(opt?.dataset?.prof ?? '3.0');
          const inp = document.querySelector(`.prof-input-change[data-user-id="${uid}"]`);
          if (inp){ inp.value = clampProf(prof).toFixed(1); }
          updateChangeButtonState();
        });
      });

      // Proficiency controls
      document.querySelectorAll('.prof-input-change').forEach(inp=>{
        inp.addEventListener('input', ()=>{ normalizeProf(inp); updateChangeButtonState(); });
        inp.addEventListener('blur', ()=>{ normalizeProf(inp,true); updateChangeButtonState(); });
      });
      document.querySelectorAll('[data-act="inc-change"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const inp = document.querySelector(`.prof-input-change[data-user-id="${btn.dataset.userId}"]`);
          nudgeProf(inp, +0.5); updateChangeButtonState();
        });
      });
      document.querySelectorAll('[data-act="dec-change"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const inp = document.querySelector(`.prof-input-change[data-user-id="${btn.dataset.userId}"]`);
          nudgeProf(inp, -0.5); updateChangeButtonState();
        });
      });

      // Row checkbox changes
      document.querySelectorAll('.user-checkbox-change').forEach(cb=>cb.addEventListener('change', updateChangeButtonState));
      updateChangeButtonState();
    }

    // ===== Button states =====
    function updateRemoveButtonState(){
      const btn = document.getElementById('removeSkills');
      const checked = [...document.querySelectorAll('.user-checkbox-remove:checked')];
      let ok=false;
      checked.forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-remove[data-user-id="${uid}"]`);
        if (sel && sel.value) ok=true;
      });
      btn.disabled = !(checked.length>0 && ok);
    }

    function updateAddButtonState(){
      const btn = document.getElementById('addSkills');
      const checked = [...document.querySelectorAll('.user-checkbox-add:checked')];
      let ok = checked.length>0;
      checked.forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-add[data-user-id="${uid}"]`);
        const inp = document.querySelector(`.prof-input[data-user-id="${uid}"]`);
        if (!sel || !sel.value) ok=false;
        if (!inp || !validProf(inp.value)) ok=false;
      });
      btn.disabled = !ok;
    }

    function updateChangeButtonState(){
      const btn = document.getElementById('updateProficiency');
      const checked = [...document.querySelectorAll('.user-checkbox-change:checked')];
      let ok = checked.length>0;
      checked.forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-change[data-user-id="${uid}"]`);
        const inp = document.querySelector(`.prof-input-change[data-user-id="${uid}"]`);
        if (!sel || !sel.value) ok=false;
        if (!inp || !validProf(inp.value)) ok=false;
      });
      btn.disabled = !ok;
    }

    // ===== Actions =====
    async function removeSelectedSkills(){
      const ops = [];
      document.querySelectorAll('.user-checkbox-remove:checked').forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-remove[data-user-id="${uid}"]`);
        if (sel && sel.value) ops.push({ userId: uid, skillId: sel.value });
      });
      if (!ops.length){ showMessage('No valid operations to perform.'); return; }

      const btn = document.getElementById('removeSkills');
      try{
        btn.disabled=true; btn.textContent='Processing...';
        const results = await Promise.allSettled(ops.map(op => removeSkillFromUser(op.userId, op.skillId)));
        const failures = results.filter(r=>r.status==='rejected');
        if (failures.length){ showMessage(`Completed with ${failures.length} error(s). Check console for details.`); }
        else { showMessage('All skill removals completed successfully!','success'); }
        await fetchUsers('remove');
      } catch(e){
        console.error('Remove error:', e);
        showMessage(`Failed to remove skills: ${e.message}`);
      } finally {
        btn.disabled=false; btn.textContent='Remove Selected Skills from Selected Users';
      }
    }

    async function addSelectedSkills(){
      const ops = [];
      document.querySelectorAll('.user-checkbox-add:checked').forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-add[data-user-id="${uid}"]`);
        const inp = document.querySelector(`.prof-input[data-user-id="${uid}"]`);
        if (sel && sel.value && validProf(inp.value)){
          ops.push({ userId: uid, id: sel.value, proficiency: clampProf(parseFloat(inp.value)) });
        }
      });
      if (!ops.length){
        showMessage('No valid operations to perform. Please ensure you selected users, a skill, and a valid proficiency.');
        return;
      }

      const btn = document.getElementById('addSkills');
      try{
        btn.disabled=true; btn.textContent='Processing...';
        const results = await Promise.allSettled(ops.map(op => addOrUpdateSkill(op.userId, op.id, op.proficiency)));
        const failures = results.filter(r=>r.status==='rejected');
        if (failures.length){
          const msgs = failures.map(f => f.reason?.message || 'Unknown error').join('; ');
          showMessage(`Completed with ${failures.length} error(s): ${msgs}`);
        } else {
          showMessage('All skill additions completed successfully!','success');
        }
        await fetchUsers('add');
      } catch(e){
        console.error('Add error:', e);
        showMessage(`Failed to add skills: ${e.message}`);
      } finally {
        btn.disabled=false; btn.textContent='Add Selected Skills to Selected Users';
      }
    }

    async function updateSelectedProficiency(){
      const ops = [];
      document.querySelectorAll('.user-checkbox-change:checked').forEach(cb=>{
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-change[data-user-id="${uid}"]`);
        const inp = document.querySelector(`.prof-input-change[data-user-id="${uid}"]`);
        if (sel && sel.value && validProf(inp.value)){
          ops.push({ userId: uid, id: sel.value, proficiency: clampProf(parseFloat(inp.value)) });
        }
      });
      if (!ops.length){
        showMessage('No valid operations to perform. Please ensure you selected users, a skill, and a valid proficiency.');
        return;
      }

      const btn = document.getElementById('updateProficiency');
      try{
        btn.disabled=true; btn.textContent='Processing...';
        // POST with same skill id updates proficiency in Genesys Cloud
        const results = await Promise.allSettled(ops.map(op => addOrUpdateSkill(op.userId, op.id, op.proficiency)));
        const failures = results.filter(r=>r.status==='rejected');
        if (failures.length){
          const msgs = failures.map(f => f.reason?.message || 'Unknown error').join('; ');
          showMessage(`Completed with ${failures.length} error(s): ${msgs}`);
        } else {
          showMessage('Proficiency updated successfully!','success');
        }
        await fetchUsers('change');
      } catch(e){
        console.error('Change error:', e);
        showMessage(`Failed to update proficiency: ${e.message}`);
      } finally {
        btn.disabled=false; btn.textContent='Update Proficiency for Selected';
      }
    }

    // ===== API calls =====
    async function removeSkillFromUser(userId, skillId){
      const url = `https://api.mypurecloud.ie/api/v2/users/${userId}/routingskills/${skillId}`;
      const res = await fetch(url, { method:'DELETE', headers: authHeaders() });
      if (!res.ok) throw new Error((await safeJson(res))?.message || `Failed to remove skill ${skillId} from user ${userId}`);
      return true;
    }

    // Genesys accepts POST to add OR update proficiency for an existing routing skill
    async function addOrUpdateSkill(userId, skillId, proficiency){
      const url = `https://api.mypurecloud.ie/api/v2/users/${userId}/routingskills`;
      const body = { id: skillId, proficiency: Number(proficiency) };
      const res = await fetch(url, { method:'POST', headers: authHeaders(), body: JSON.stringify(body) });
      if (!res.ok) throw new Error((await safeJson(res))?.message || `Failed to set skill ${skillId} for user ${userId}`);
      return true;
    }

    // ===== Proficiency helpers =====
    function normalizeProf(inp, snap=false){
      let v = parseFloat(inp.value);
      if (Number.isNaN(v)) { inp.value=''; return; }
      if (snap) v = roundHalf(v);
      inp.value = clampProf(v).toFixed(1);
    }
    function nudgeProf(inp, delta){
      let v = parseFloat(inp.value);
      if (Number.isNaN(v)) v = 3.0;
      v = clampProf(roundHalf(v + delta));
      inp.value = v.toFixed(1);
    }
    function validProf(v){
      const n = parseFloat(v); if (Number.isNaN(n)) return false;
      return n>=1 && n<=5 && Math.abs(n*2 - Math.round(n*2)) < 1e-9; // steps of 0.5
    }
    function clampProf(v){ return Math.min(5, Math.max(1, v)); }
    function roundHalf(v){ return Math.round(v*2)/2; }

    // ===== Utils =====
    function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
  </script>
</body>
</html>
