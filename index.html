const API_BASE = "https://api.mypurecloud.ie/api/v2";
let queues = [];
let queueAgents = [];
const ACCESS_TOKEN = "9158a5a9-9572-4766-a392-343bc7e51734"; // Replace with a valid access token

async function fetchQueues() {
  try {
    const response = await fetch(`${API_BASE}/routing/queues`, {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${ACCESS_TOKEN}`,
        "Content-Type": "application/json"
      }
    });
    if (!response.ok) throw new Error("Failed to fetch queues");
    
    const data = await response.json();
    queues = data.entities;
    populateQueueDropdown();
  } catch (error) {
    console.error("Error fetching queues:", error);
  }
}

function populateQueueDropdown() {
  const dropdown = document.getElementById("queueDropdown");
  dropdown.innerHTML = "";
  queues.forEach(queue => {
    let option = document.createElement("option");
    option.value = queue.id;
    option.textContent = queue.name;
    dropdown.appendChild(option);
  });
}

async function fetchAgents() {
  const selectedQueueId = document.getElementById("queueDropdown").value;
  if (!selectedQueueId) {
    alert("Please select a queue first.");
    return;
  }
  
  try {
    const agentsResponse = await fetch(`${API_BASE}/routing/queues/${selectedQueueId}/members`, {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${ACCESS_TOKEN}`,
        "Content-Type": "application/json"
      }
    });
    if (!agentsResponse.ok) throw new Error("Failed to fetch queue members");

    queueAgents = await agentsResponse.json();
    displayAgents();
  } catch (error) {
    console.error("Error fetching agents:", error);
  }
}

async function fetchSkills(userId) {
  try {
    const response = await fetch(`${API_BASE}/users/${userId}/routingskills`, {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${ACCESS_TOKEN}`,
        "Content-Type": "application/json"
      }
    });
    if (!response.ok) throw new Error("Failed to fetch skills");
    
    return await response.json();
  } catch (error) {
    console.error(`Error fetching skills for user ${userId}:`, error);
    return { entities: [] };
  }
}

async function displayAgents() {
  const tableBody = document.querySelector("#agentsTable tbody");
  tableBody.innerHTML = "";
  for (let agent of queueAgents.entities) {
    let skillsData = await fetchSkills(agent.id);
    let row = document.createElement("tr");
    row.innerHTML = `
      <td>${agent.name}</td>
      <td>${skillsData.entities.map(skill => skill.name).join(", ")}</td>
      <td><input type="text" data-user-id="${agent.id}"></td>
    `;
    tableBody.appendChild(row);
  }
}

async function updateSkills() {
  const inputs = document.querySelectorAll("#agentsTable input");
  for (let input of inputs) {
    const userId = input.dataset.userId;
    const newSkill = input.value;
    if (newSkill) {
      try {
        await fetch(`${API_BASE}/users/${userId}/routingskills`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${ACCESS_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify([{ name: newSkill }])
        });
      } catch (error) {
        console.error(`Error updating skills for user ${userId}:`, error);
      }
    }
  }
  alert("Skills updated. Note: This overwrites existing skills.");
}

document.getElementById("fetchQueues").addEventListener("click", fetchQueues);
document.getElementById("fetchAgents").addEventListener("click", fetchAgents);
document.getElementById("updateSkills").addEventListener("click", updateSkills);
