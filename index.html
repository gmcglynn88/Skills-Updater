<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPI Skill Updates</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{font-family:'Segoe UI',Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg);font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;align-items:end}
    .inline{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center} .inline span{color:var(--text-light)}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light)} .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .loading{opacity:.6;pointer-events:none}
    .selection-section {margin-bottom: 20px;padding: 15px;border: 1px solid var(--border-color);border-radius: 8px;background-color: var(--light-bg);}
    .selection-section h3 {margin-top: 0;color: var(--primary-color);}
    .action-button {margin-top: 20px;}
    table {width: 100%;border-collapse: collapse;margin-top: 20px;}
    th, td {border: 1px solid var(--border-color);padding: 10px;text-align: left;vertical-align: middle;}
    th {background-color: var(--primary-color);color: white;}
    .select-all-checkbox {margin-bottom: 10px;}
    .error-message {color: #d9534f;padding: 10px;margin: 10px 0;border: 1px solid #d9534f;border-radius: 4px;background-color: #f9f2f2;}
    .success-message {color: #3c763d;padding: 10px;margin: 10px 0;border: 1px solid #3c763d;border-radius: 4px;background-color: #dff0d8;}
    .tab-container {display: flex;margin-bottom: 20px;border-bottom: 1px solid var(--border-color);}
    .tab {padding: 12px 24px;cursor: pointer;border: 1px solid var(--border-color);border-bottom: none;border-radius: 8px 8px 0 0;margin-right: 4px;background: var(--light-bg);transition: background 0.2s;}
    .tab.active {background: var(--primary-color);color: white;border-color: var(--primary-color);}
    .tab-content {display: none;}
    .tab-content.active {display: block;}
    .pill{display:inline-block;background:var(--pill);border:1px solid var(--border-color);border-radius:999px;padding:8px 12px;font-size:14px;margin-right:6px;cursor:pointer}
    .note{font-size:12px;color:var(--text-light)}
    .prof-input-wrap{display:flex;gap:8px;align-items:center}
    .prof-input{width:80px}
    .tiny-btn{padding:8px 10px;font-size:14px;line-height:1}

    /* Checkbox dropdown */
    .checkbox-dropdown{position:relative;min-width:260px}
    .cd-trigger{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border-color);border-radius:6px;background:#fff;padding:10px;cursor:pointer}
    .cd-trigger .label{color:var(--text-color)}
    .cd-trigger .count{background:var(--pill);border:1px solid var(--border-color);border-radius:999px;padding:2px 8px;font-size:12px;color:#2c3e50}
    .cd-panel{position:absolute;z-index:1000;margin-top:6px;background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;max-height:340px;overflow:hidden;display:none}
    .cd-panel.open{display:block}
    .cd-header{padding:10px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}
    .cd-search{flex:1;border:1px solid var(--border-color);border-radius:6px;padding:8px}
    .cd-actions{display:flex;gap:8px}
    .cd-actions button{background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);border-radius:6px;padding:8px 10px;cursor:pointer}
    .cd-list{max-height:260px;overflow:auto}
    .cd-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f3f5}
    .cd-item label{display:flex;align-items:center;gap:10px;cursor:pointer;width:100%}
    .cd-footer{padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);font-size:12px;color:var(--text-light);display:flex;justify-content:space-between}
    .cd-selectall{padding:8px 12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px}
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>
  <h1>Skill Management Tool</h1>

  <div id="loginSection" class="card" style="text-align: center; margin: 20px;">
    <div class="loading">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display: none;">
    <div id="messageContainer" style="display: none;"></div>

    <div class="tab-container">
      <div class="tab active" data-tab="remove">Remove Skills</div>
      <div class="tab" data-tab="add">Add Skills</div>
    </div>

    <!-- Remove Skills Tab -->
    <div id="removeTab" class="tab-content active">
      <div class="selection-section">
        <h3>Search Options</h3>
        <div class="controls">
          <div>
            <label for="agentDropdownRemove">Select Agents</label>
            <div id="agentDropdownRemove" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="skillDropdownRemove">Select Skill</label>
            <select id="skillDropdownRemove">
              <option value="">Select Skill</option>
            </select>
          </div>
          <div>
            <label for="teamDropdownRemove">Select Work Team</label>
            <select id="teamDropdownRemove">
              <option value="">Select Team</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="fetchUsersRemove" class="full-width-btn">Get Users</button>
          </div>
        </div>
        <div class="note">Tip: Choosing only a Skill shows users who have that skill directly assigned.</div>
      </div>

      <div class="card">
        <h2 style="margin: 0 0 12px;">Routing Skills - Remove</h2>
        <table id="userSkillsTableRemove">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsersRemove" class="select-all-checkbox"></th>
              <th>Agent</th>
              <th>Skills Assigned</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <button id="removeSkills" class="full-width-btn action-button" disabled>Remove Selected Skills from Selected Users</button>
      </div>
    </div>

    <!-- Add Skills Tab -->
    <div id="addTab" class="tab-content">
      <div class="selection-section">
        <h3>Search Options</h3>
        <div class="controls">
          <div>
            <label for="agentDropdownAdd">Select Agents</label>
            <div id="agentDropdownAdd" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="skillDropdownAdd">Select Skill</label>
            <select id="skillDropdownAdd">
              <option value="">Select Skill</option>
            </select>
          </div>
          <div>
            <label for="teamDropdownAdd">Select Work Team</label>
            <select id="teamDropdownAdd">
              <option value="">Select Team</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="fetchUsersAdd" class="full-width-btn">Get Users</button>
          </div>
        </div>
        <div class="note">Proficiency can be typed or nudged in ±0.5 steps (min 1, max 5).</div>
      </div>

      <div class="card">
        <h2 style="margin: 0 0 12px;">Routing Skills - Add</h2>
        <table id="userSkillsTableAdd">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsersAdd" class="select-all-checkbox"></th>
              <th>Agent</th>
              <th>Skills Assigned</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <button id="addSkills" class="full-width-btn action-button" disabled>Add Selected Skills to Selected Users</button>
      </div>
    </div>
  </div>

  <script>
    // ======== CONFIG ========
    const clientId = 'd4529142-7340-4cd8-a9f9-f3a4d25670df';
    const redirectUri = 'https://gmcglynn88.github.io/Skills-Updater/';
    const responseType = 'token';
    const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=${responseType}&redirect_uri=${encodeURIComponent(redirectUri)}`;

    // ======== STATE ========
    let token = null;
    let availableUsers = [];
    let availableTeams = [];
    let availableSkills = [];

    // Dropdown instances
    let agentDropdownRemoveDD = null;
    let agentDropdownAddDD = null;

    // ======== BOOT ========
    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      token = params.get('access_token');

      if (token) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        initializeApp();
      } else {
        window.location.href = oauthUrl;
      }
    });

    function showMessage(message, type = 'error') {
      const messageContainer = document.getElementById('messageContainer');
      messageContainer.innerHTML = `<div class="${type}-message">${message}</div>`;
      messageContainer.style.display = 'block';
      if (type === 'success') setTimeout(() => messageContainer.style.display = 'none', 5000);
    }

    // ======== INIT ========
    async function initializeApp() {
      try {
        await Promise.all([
          fetchAllUsers(),
          fetchAllTeams(),
          fetchAllSkills()
        ]);
        createAgentDropdowns();
        populateDropdowns();
        setupEventListeners();
      } catch (error) {
        console.error("Initialization error:", error);
        showMessage("Error initializing application. Please try again.");
        setTimeout(() => window.location.href = oauthUrl, 3000);
      }
    }

    // ======== DATA FETCHING ========
    async function fetchAllUsers() {
      let all = [], pageNumber = 1, pageSize = 100, total = 0;
      do {
        const url = `https://api.mypurecloud.ie/api/v2/users?pageNumber=${pageNumber}&pageSize=${pageSize}`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error((await res.json()).message || "Failed to fetch users");
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0;
        pageNumber++;
      } while (all.length < total);
      availableUsers = all;
    }

    async function fetchAllTeams() {
      let all = [], pageNumber = 1, pageSize = 100, total = 0;
      do {
        const url = `https://api.mypurecloud.ie/api/v2/teams?pageNumber=${pageNumber}&pageSize=${pageSize}`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error((await res.json()).message || "Failed to fetch teams");
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0;
        pageNumber++;
      } while (all.length < total);
      availableTeams = all;
    }

    async function fetchAllSkills() {
      let all = [], pageNumber = 1, pageSize = 100, total = 0;
      do {
        const url = `https://api.mypurecloud.ie/api/v2/routing/skills?pageNumber=${pageNumber}&pageSize=${pageSize}`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error((await res.json()).message || "Failed to fetch skills");
        const data = await res.json();
        all = all.concat(data.entities || []);
        total = data.total || 0;
        pageNumber++;
      } while (all.length < total);
      availableSkills = all;
    }

    function authHeaders() {
      return { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
    }

    // ======== CUSTOM CHECKBOX DROPDOWN ========
    function createCheckboxDropdown(containerId, { placeholder='Select agents', searchPlaceholder='Search agents...' } = {}) {
      const root = document.getElementById(containerId);
      root.innerHTML = '';

      // Trigger
      const trigger = document.createElement('div');
      trigger.className = 'cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);

      // Panel
      const panel = document.createElement('div');
      panel.className = 'cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions">
            <button type="button" data-cd="clear">Clear</button>
          </div>
        </div>
        <div class="cd-selectall">
          <label><input type="checkbox" data-cd="selectall"/> Select all</label>
        </div>
        <div class="cd-list"></div>
        <div class="cd-footer">
          <span data-cd="summary">0 selected</span>
          <span>Click outside to close</span>
        </div>
      `;
      root.appendChild(panel);

      const list = panel.querySelector('.cd-list');
      const search = panel.querySelector('.cd-search');
      const clearBtn = panel.querySelector('[data-cd="clear"]');
      const selectAll = panel.querySelector('[data-cd="selectall"]');
      const summary = panel.querySelector('[data-cd="summary"]');

      let options = [];   // [{value, label}]
      let selected = new Set();

      function renderItems(filterText='') {
        const ft = filterText.trim().toLowerCase();
        list.innerHTML = '';
        const filtered = !ft ? options : options.filter(o => (o.label || '').toLowerCase().includes(ft));
        if (!filtered.length) {
          list.innerHTML = `<div class="cd-item" style="color:#6C757D">No matches</div>`;
          return;
        }
        filtered.forEach(o => {
          const id = `${containerId}__${o.value}`;
          const row = document.createElement('div');
          row.className = 'cd-item';
          row.innerHTML = `
            <label for="${id}">
              <input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value)?'checked':''}/>
              <span>${o.label || o.value}</span>
            </label>
          `;
          const cb = row.querySelector('input[type="checkbox"]');
          cb.addEventListener('change', () => {
            if (cb.checked) selected.add(o.value);
            else selected.delete(o.value);
            updateSummary();
            updateSelectAllState();
          });
          list.appendChild(row);
        });
      }

      function updateSummary() {
        const count = selected.size;
        trigger.querySelector('.count').textContent = `${count} selected`;
        summary.textContent = `${count} selected`;
      }

      function updateSelectAllState() {
        const total = options.length;
        const count = selected.size;
        selectAll.indeterminate = count > 0 && count < total;
        selectAll.checked = total > 0 && count === total;
      }

      // Events
      trigger.addEventListener('click', () => {
        panel.classList.toggle('open');
        search.focus();
      });
      document.addEventListener('click', (e) => {
        if (!root.contains(e.target)) panel.classList.remove('open');
      });
      search.addEventListener('input', () => renderItems(search.value));
      clearBtn.addEventListener('click', () => {
        selected.clear();
        renderItems(search.value);
        updateSummary();
        updateSelectAllState();
      });
      selectAll.addEventListener('change', () => {
        if (selectAll.checked) options.forEach(o => selected.add(o.value));
        else selected.clear();
        renderItems(search.value);
        updateSummary();
      });

      function setOptions(newOptions) {
        options = newOptions || [];
        // remove any selections not in options
        selected.forEach(v => { if (!options.some(o => o.value === v)) selected.delete(v); });
        renderItems(search.value);
        updateSummary();
        updateSelectAllState();
      }
      function getSelectedValues() { return Array.from(selected); }

      // initial render
      renderItems('');

      return { setOptions, getSelectedValues };
    }

    function createAgentDropdowns() {
      agentDropdownRemoveDD = createCheckboxDropdown('agentDropdownRemove');
      agentDropdownAddDD = createCheckboxDropdown('agentDropdownAdd');
    }

    // ======== DROPDOWNS ========
    function populateDropdowns() {
      // Agents -> into custom checkbox dropdowns
      const valid = availableUsers
        .filter(u => u.name && u.name.trim() !== '' && u.name !== 'Unknown User')
        .map(u => ({ value: u.id, label: u.name || u.email || 'Unknown User' }))
        .sort((a,b) => a.label.localeCompare(b.label));

      agentDropdownRemoveDD.setOptions(valid);
      agentDropdownAddDD.setOptions(valid);

      // Skills
      populateSkillDropdown('skillDropdownRemove');
      populateSkillDropdown('skillDropdownAdd');

      // Teams
      populateTeamDropdown('teamDropdownRemove');
      populateTeamDropdown('teamDropdownAdd');
    }

    function populateSkillDropdown(id) {
      const el = document.getElementById(id);
      el.innerHTML = '<option value="">Select Skill</option>';
      availableSkills.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        el.appendChild(opt);
      });
    }

    function populateTeamDropdown(id) {
      const el = document.getElementById(id);
      el.innerHTML = '<option value="">Select Team</option>';
      availableTeams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        el.appendChild(opt);
      });
    }

    // ======== EVENTS ========
    function setupEventListeners() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
        });
      });

      // Remove tab
      document.getElementById('fetchUsersRemove').addEventListener('click', () => fetchUsers('remove'));
      document.getElementById('removeSkills').addEventListener('click', () => removeSelectedSkills());
      document.getElementById('selectAllUsersRemove').addEventListener('change', function() {
        document.querySelectorAll('#userSkillsTableRemove tbody input[type="checkbox"]').forEach(cb => cb.checked = this.checked);
        updateRemoveButtonState();
      });

      // Add tab
      document.getElementById('fetchUsersAdd').addEventListener('click', () => fetchUsers('add'));
      document.getElementById('addSkills').addEventListener('click', () => addSelectedSkills());
      document.getElementById('selectAllUsersAdd').addEventListener('change', function() {
        document.querySelectorAll('#userSkillsTableAdd tbody input[type="checkbox"]').forEach(cb => cb.checked = this.checked);
        updateAddButtonState();
      });
    }

    function getSelectedAgentIds(mode){
      return mode === 'remove'
        ? agentDropdownRemoveDD.getSelectedValues()
        : agentDropdownAddDD.getSelectedValues();
    }

    // ======== USER GATHERING & TABLE POP ========
    async function fetchUsers(mode) {
      const skillSelId = `skillDropdown${cap(mode)}`;
      const teamSelId  = `teamDropdown${cap(mode)}`;

      const agentIds = getSelectedAgentIds(mode);
      const skillId  = document.getElementById(skillSelId).value;
      const teamId   = document.getElementById(teamSelId).value;

      if (agentIds.length === 0 && !skillId && !teamId) {
        showMessage('Please select at least one search option.');
        return;
      }

      try {
        const tableBody = document.querySelector(`#userSkillsTable${cap(mode)} tbody`);
        tableBody.innerHTML = '<tr><td colspan="4" class="loading">Loading users...</td></tr>';

        let users = [];

        if (agentIds.length > 0) {
          users = agentIds.map(id => availableUsers.find(u => u.id === id)).filter(Boolean);
        } else if (teamId) {
          const teamMembers = await fetchTeamMembers(teamId);
          users = await processTeamMembers(teamMembers);
        } else if (skillId) {
          // No agents/teams picked: start from all users then filter later by direct skill
          users = availableUsers.filter(u => u.name && u.name.trim() && u.name !== 'Unknown User');
        }

        if (users.length === 0) {
          showMessage('No users found for the selected criteria.');
          return;
        }

        // Fetch direct skills per user (batched)
        const usersWithSkills = await fetchSkillsForUsersBatched(users, 10);

        // Filter by selected skill (direct skills only are loaded)
        let filtered = usersWithSkills;
        if (skillId) {
          const hasSkill = skills => skills.some(s => s.id === skillId);
          if (mode === 'remove') filtered = usersWithSkills.filter(({ skills }) => hasSkill(skills));
          else filtered = usersWithSkills.filter(({ skills }) => !hasSkill(skills));
        }

        if (mode === 'remove') populateRemoveTable(filtered);
        else populateAddTable(filtered, skillId);

      } catch (e) {
        console.error("Error fetching users:", e);
        showMessage(`Failed to fetch users: ${e.message}`);
      }
    }

    async function fetchTeamMembers(teamId) {
      const url = `https://api.mypurecloud.ie/api/v2/teams/${teamId}/members`;
      const res = await fetch(url, { headers: authHeaders() });
      if (!res.ok) throw new Error((await res.json()).message || `Failed to fetch members for team ${teamId}`);
      const data = await res.json();
      return data.entities || [];
    }

    async function processTeamMembers(teamMembers) {
      const users = [];
      for (const member of teamMembers) {
        const userId = member.id;
        if (!userId) continue;
        const user = availableUsers.find(u => u.id === userId);
        if (user && user.name && user.name.trim() !== '' && user.name !== 'Unknown User') users.push(user);
      }
      return users;
    }

    // === Direct skills only ===
    async function fetchUserSkillsForUser(userId) {
      const url = `https://api.mypurecloud.ie/api/v2/users/${userId}/routingskills`;
      try {
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) {
          if (res.status === 404) return [];
          const err = await safeJson(res);
          throw new Error(err?.message || `Failed to fetch skills for user ${userId}`);
        }
        const data = await res.json();
        // API can return an array or {entities:[]}; support both.
        const list = Array.isArray(data) ? data : (data.entities || []);
        return (list || []).map(s => ({
          id: s.id,
          name: s.name || (availableSkills.find(as => as.id === s.id)?.name) || 'Unknown Skill',
          proficiency: typeof s.proficiency === 'number' ? s.proficiency : null
        }));
      } catch (e) {
        console.error(`Error fetching skills for user ${userId}:`, e);
        return [];
      }
    }

    async function fetchSkillsForUsersBatched(users, batchSize=10) {
      const result = [];
      for (let i = 0; i < users.length; i += batchSize) {
        const chunk = users.slice(i, i + batchSize);
        const data = await Promise.all(chunk.map(async (user) => {
          const skills = await fetchUserSkillsForUser(user.id);
          return { user, skills };
        }));
        result.push(...data);
      }
      return result;
    }

    function populateRemoveTable(usersWithSkills) {
      const tbody = document.querySelector('#userSkillsTableRemove tbody');
      tbody.innerHTML = "";

      if (!usersWithSkills.length) {
        tbody.innerHTML = '<tr><td colspan="4">No users found.</td></tr>';
        updateRemoveButtonState();
        return;
      }

      usersWithSkills.forEach(({ user, skills }) => {
        const assignedText = skills.length
          ? skills.map(s => `${s.name}${formatProf(s.proficiency)}`).join(', ')
          : 'No Skills';

        const skillOptions = skills.length
          ? ['<option value="">Select Skill to Remove</option>', ...skills.map(s => `<option value="${s.id}">${s.name}${formatProf(s.proficiency)}</option>`)].join('')
          : '<option value="">No Skills Assigned</option>';

        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="checkbox" data-user-id="${user.id}" class="user-checkbox-remove"></td>
          <td>${user.name}</td>
          <td>${assignedText}</td>
          <td>
            <select data-user-id="${user.id}" class="skill-select-remove" ${skills.length ? '' : 'disabled'}>
              ${skillOptions}
            </select>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.querySelectorAll('.user-checkbox-remove').forEach(cb => cb.addEventListener('change', updateRemoveButtonState));
      document.querySelectorAll('.skill-select-remove').forEach(sel => sel.addEventListener('change', updateRemoveButtonState));
      updateRemoveButtonState();
    }

    function populateAddTable(usersWithSkills, preselectedSkillId="") {
      const tbody = document.querySelector('#userSkillsTableAdd tbody');
      tbody.innerHTML = "";

      if (!usersWithSkills.length) {
        tbody.innerHTML = '<tr><td colspan="4">No users found.</td></tr>';
        updateAddButtonState();
        return;
      }

      usersWithSkills.forEach(({ user, skills }) => {
        const assignedIds = skills.map(s => s.id);
        const choices = availableSkills.filter(s => !assignedIds.includes(s.id));
        const options = choices.length
          ? ['<option value="">Select Skill to Add</option>', ...choices.map(s => `<option value="${s.id}" ${s.id===preselectedSkillId?'selected':''}>${s.name}</option>`)].join('')
          : '<option value="">All Skills Assigned</option>';

        const assignedText = skills.length
          ? skills.map(s => `${s.name}${formatProf(s.proficiency)}`).join(', ')
          : 'No Skills';

        const disabled = choices.length ? '' : 'disabled';
        const defaultProf = 3.0;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="checkbox" data-user-id="${user.id}" class="user-checkbox-add"></td>
          <td>${user.name}</td>
          <td>${assignedText}</td>
          <td>
            <div style="display:grid;grid-template-columns: minmax(220px, 1fr) auto; gap: 12px; align-items:center;">
              <select data-user-id="${user.id}" class="skill-select-add" ${disabled}>
                ${options}
              </select>
              <div class="prof-input-wrap">
                <button type="button" class="tiny-btn dec-prof" data-user-id="${user.id}">−</button>
                <input type="number" step="0.5" min="1" max="5" class="prof-input" data-user-id="${user.id}" value="${defaultProf}" ${disabled}/>
                <button type="button" class="tiny-btn inc-prof" data-user-id="${user.id}">+</button>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.querySelectorAll('.user-checkbox-add').forEach(cb => cb.addEventListener('change', updateAddButtonState));
      document.querySelectorAll('.skill-select-add').forEach(sel => sel.addEventListener('change', updateAddButtonState));
      document.querySelectorAll('.prof-input').forEach(inp => {
        inp.addEventListener('input', () => { normalizeProficiencyInput(inp); updateAddButtonState(); });
        inp.addEventListener('blur', () => { normalizeProficiencyInput(inp, true); updateAddButtonState(); });
      });
      document.querySelectorAll('.inc-prof').forEach(btn => {
        btn.addEventListener('click', () => {
          const input = document.querySelector(`.prof-input[data-user-id="${btn.dataset.userId}"]`);
          nudgeProficiency(input, +0.5);
          updateAddButtonState();
        });
      });
      document.querySelectorAll('.dec-prof').forEach(btn => {
        btn.addEventListener('click', () => {
          const input = document.querySelector(`.prof-input[data-user-id="${btn.dataset.userId}"]`);
          nudgeProficiency(input, -0.5);
          updateAddButtonState();
        });
      });

      updateAddButtonState();
    }

    // ======== BUTTON STATES ========
    function updateRemoveButtonState() {
      const removeButton = document.getElementById('removeSkills');
      const checked = [...document.querySelectorAll('.user-checkbox-remove:checked')];
      let ok = false;
      checked.forEach(cb => {
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-remove[data-user-id="${uid}"]`);
        if (sel && sel.value) ok = true;
      });
      removeButton.disabled = !(checked.length > 0 && ok);
    }

    function updateAddButtonState() {
      const addButton = document.getElementById('addSkills');
      const checked = [...document.querySelectorAll('.user-checkbox-add:checked')];
      let ok = true;
      if (checked.length === 0) ok = false;

      checked.forEach(cb => {
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-add[data-user-id="${uid}"]`);
        const inp = document.querySelector(`.prof-input[data-user-id="${uid}"]`);
        if (!sel || !sel.value) ok = false;
        if (!inp || !isValidProficiency(inp.value)) ok = false;
      });

      addButton.disabled = !ok;
    }

    // ======== ACTIONS ========
    async function removeSelectedSkills() {
      const checked = [...document.querySelectorAll('.user-checkbox-remove:checked')];
      const operations = [];

      checked.forEach(cb => {
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-remove[data-user-id="${uid}"]`);
        const sid = sel ? sel.value : null;
        if (sid) operations.push({ userId: uid, skillId: sid });
      });

      if (!operations.length) { showMessage('No valid operations to perform.'); return; }

      const btn = document.getElementById('removeSkills');
      try {
        btn.disabled = true; btn.textContent = 'Processing...';
        const results = await Promise.allSettled(operations.map(op => removeSkillFromUser(op.userId, op.skillId)));
        const failures = results.filter(r => r.status === 'rejected');
        if (failures.length) {
          console.error("Some removals failed:", failures);
          showMessage(`Completed with ${failures.length} error(s). Check console for details.`);
        } else {
          showMessage('All skill removals completed successfully!', 'success');
        }
        await fetchUsers('remove');
      } catch (e) {
        console.error("Error removing skills:", e);
        showMessage(`Failed to remove skills: ${e.message}`);
      } finally {
        btn.disabled = false; btn.textContent = 'Remove Selected Skills from Selected Users';
      }
    }

    async function addSelectedSkills() {
      const checked = [...document.querySelectorAll('.user-checkbox-add:checked')];
      const operations = [];

      checked.forEach(cb => {
        const uid = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.skill-select-add[data-user-id="${uid}"]`);
        const inp = document.querySelector(`.prof-input[data-user-id="${uid}"]`);
        const sid = sel ? sel.value : null;
        const prof = inp ? clampProficiency(parseFloat(inp.value)) : null;
        if (sid && isValidProficiency(prof)) operations.push({ userId: uid, skillId: sid, proficiency: prof });
      });

      if (!operations.length) {
        showMessage('No valid operations to perform. Please ensure you selected users, a skill, and a valid proficiency.');
        return;
      }

      const btn = document.getElementById('addSkills');
      try {
        btn.disabled = true; btn.textContent = 'Processing...';
        const results = await Promise.allSettled(operations.map(op => addSkillToUser(op.userId, op.skillId, op.proficiency)));
        const failures = results.filter(r => r.status === 'rejected');
        if (failures.length) {
          const msgs = failures.map(f => f.reason?.message || 'Unknown error').join('; ');
          console.error("Some additions failed:", failures);
          showMessage(`Completed with ${failures.length} error(s): ${msgs}`);
        } else {
          showMessage('All skill additions completed successfully!', 'success');
        }
        await fetchUsers('add');
      } catch (e) {
        console.error("Error adding skills:", e);
        showMessage(`Failed to add skills: ${e.message}`);
      } finally {
        btn.disabled = false; btn.textContent = 'Add Selected Skills to Selected Users';
      }
    }

    // ======== API CALLS (per-user) ========
    async function removeSkillFromUser(userId, skillId) {
      const url = `https://api.mypurecloud.ie/api/v2/users/${userId}/routingskills/${skillId}`;
      const res = await fetch(url, { method: 'DELETE', headers: authHeaders() });
      if (!res.ok) throw new Error((await safeJson(res))?.message || `Failed to remove skill ${skillId} from user ${userId}`);
      return { userId, skillId, success: true };
    }

    async function addSkillToUser(userId, skillId, proficiency) {
      const url = `https://api.mypurecloud.ie/api/v2/users/${userId}/routingskills`;
      const body = { id: skillId, proficiency: Number(proficiency) };
      const res = await fetch(url, { method: 'POST', headers: authHeaders(), body: JSON.stringify(body) });
      if (!res.ok) throw new Error((await safeJson(res))?.message || `Failed to add skill ${skillId} to user ${userId}`);
      return { userId, skillId, success: true };
    }

    async function safeJson(res) {
      try { return await res.json(); } catch { return null; }
    }

    // ======== PROFICIENCY HELPERS ========
    function formatProf(p) {
      if (typeof p !== 'number') return '';
      return ` (${p.toFixed(1)})`;
    }

    function normalizeProficiencyInput(input, snapToStep=false) {
      let v = parseFloat(input.value);
      if (Number.isNaN(v)) { input.value = ''; return; }
      if (snapToStep) v = roundToHalf(v);
      v = clampProficiency(v);
      input.value = v.toFixed(1);
    }

    function nudgeProficiency(input, delta) {
      let v = parseFloat(input.value);
      if (Number.isNaN(v)) v = 3.0;
      v = roundToHalf(v + delta);
      v = clampProficiency(v);
      input.value = v.toFixed(1);
    }

    function isValidProficiency(v) {
      const n = parseFloat(v);
      if (Number.isNaN(n)) return false;
      return n >= 1 && n <= 5 && Math.abs(n*2 - Math.round(n*2)) < 1e-9; // multiple of 0.5
    }

    function clampProficiency(v) {
      if (Number.isNaN(v)) return 3.0;
      return Math.min(5, Math.max(1, v));
    }

    function roundToHalf(v) {
      return Math.round(v * 2) / 2;
    }

    // ======== UTILS ========
    function cap(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
  </script>
</body>
</html>
